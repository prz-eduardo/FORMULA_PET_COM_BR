<div class="area-vet-wrapper">
  <h1 class="titulo">Gerar Receita</h1>

  <!-- CPF -->
  <div class="card receita-card">
    <h3>CPF do Tutor</h3>
    <div class="row">
      <input
        type="text"
        name="cpf"
        [(ngModel)]="cpf"
        placeholder="000.000.000-00"
        mask="000.000.000-00"
        class="input-busca"
        (input)="onCpfInput()"
      />
      <button class="btn" (click)="buscarTutor()" [disabled]="carregandoTutor">Buscar</button>
    </div>
    <p *ngIf="carregandoTutor" class="muted">Buscando tutor...</p>
  </div>

  <!-- Tutor encontrado -->
  <div *ngIf="tutorEncontrado" class="card receita-card">
    <h3>Dados do Tutor</h3>
    <div class="tutor-grid">
      <div><b>Nome:</b> {{ tutorEncontrado.nome }}</div>
      <div><b>CPF:</b> {{ tutorEncontrado.cpf }}</div>
      <div><b>Telefone:</b> {{ tutorEncontrado.telefone }}</div>
      <div><b>Email:</b> {{ tutorEncontrado.email }}</div>
      <div class="full"><b>Endereço:</b> {{ tutorEncontrado.endereco }}</div>
    </div>

    <!-- Pets -->
    <h4 class="subtitulo">Pets Cadastrados</h4>
    <div class="cards-da-letra">
      <div
        *ngFor="let pet of tutorEncontrado.pets; trackBy: trackByPet"
        class="pet-card"
        [class.selected]="petSelecionado?.id === pet.id"
        (click)="selecionarPet(pet)"
      >
        <div class="ativo-header">{{ pet.nome }} <small class="muted">({{ pet.sexo }})</small></div>
        <div class="ativo-details">
          Idade: {{ pet.idade }} anos<br />
          Peso: {{ pet.peso }} kg<br />
          Raça: {{ pet.raca }}<br />
          Alergias: {{ pet.alergias || 'Nenhuma' }}<br />
          Espécie: {{ pet.especie}}
        </div>
      </div>
    </div>
  </div>

  <!-- Cadastro manual do tutor -->
  <div *ngIf="cadastroManualTutor" class="card receita-card">
    <h3>Cadastro Manual do Tutor</h3>
    <div class="grid-pet">
      <input [(ngModel)]="novoTutor.nome" placeholder="Nome completo" class="input-busca" />
      <input [(ngModel)]="novoTutor.telefone" placeholder="Telefone" class="input-busca" />
      <input [(ngModel)]="novoTutor.email" placeholder="E-mail" class="input-busca" />
      <input [(ngModel)]="novoTutor.endereco" placeholder="Endereço" class="input-busca" />
    </div>
  </div>

<!-- Novo Pet -->
    <div class="card receita-card">
    <h3>Dados do Pet (selecionado / manual)</h3>
    <div class="grid-pet">
        <div class="input-group">
        <label>Nome do Pet</label>
        <input [(ngModel)]="novosDadosPet.nome" placeholder="Nome do Pet" class="input-busca" />
        </div>

        <div class="input-group">
        <label>Idade (anos)</label>
        <input [(ngModel)]="novosDadosPet.idade" placeholder="Idade" type="number" class="input-busca" />
        </div>

        <div class="input-group">
        <label>Peso (kg)</label>
        <input [(ngModel)]="novosDadosPet.peso" placeholder="Peso" type="number" class="input-busca" />
        </div>

        <div class="input-group">
        <label>Raça</label>
        <input [(ngModel)]="novosDadosPet.raca" placeholder="Raça" class="input-busca" />
        </div>

        <div class="input-group">
        <label>Espécie</label>
        <input [(ngModel)]="novosDadosPet.especie" placeholder="Ex: Cachorro, Gato" class="input-busca" />
        </div>

        <div class="input-group">
        <label>Sexo</label>
        <select [(ngModel)]="novosDadosPet.sexo" class="input-busca">
            <option value="Macho">Macho</option>
            <option value="Fêmea">Fêmea</option>
        </select>
        </div>

        <div class="input-group">
        <label>Alergias</label>
        <input [(ngModel)]="novosDadosPet.alergias" placeholder="Alergias" class="input-busca" />
        </div>
    </div>

    </div>


  <!-- Observações -->
  <div class="card receita-card">
    <h3>Observações</h3>
    <textarea [(ngModel)]="observacoes" placeholder="Digite aqui observações da receita..." class="input-busca"></textarea>
  </div>

  <!-- Ativos -->
  <div class="card receita-card">
    <h3>Selecionar Ativos</h3>
    <div class="ativos-controls">
      <input type="text" [(ngModel)]="ativosSearch" (ngModelChange)="onAtivosSearchChange()" placeholder="Pesquisar ativo..." class="input-busca" />
      <div class="muted small">Total: {{ ativos.length }}</div>
      <button class="btn-toggle" (click)="toggleTodosAtivos()">{{ ativosColapsados ? 'Abrir todos' : 'Colapsar todos' }}</button>
    </div>

    <div class="ativos-badges" *ngIf="ativosSelecionados.length">
      <span class="badge" *ngFor="let id of ativosSelecionados">
        {{ getNomeAtivo(id) }}
        <button class="badge-remove" (click)="toggleAtivo(id)">x</button>
      </span>
    </div>

    <div *ngFor="let grupo of alfabetico">
      <div *ngIf="!isGrupoColapsado(grupo.letra)">
        <div class="grupo-header" (click)="toggleGrupo(grupo.letra)">
          <h4 class="indice-letra">{{ grupo.letra }}</h4>
        </div>

        <div class="cards-da-letra">
          <div
            class="ativo-item"
            *ngFor="let ativo of grupo.ativos; trackBy: trackByAtivo"
            (click)="toggleAtivo(ativo.id)"
            [class.selected]="ativosSelecionados.includes(ativo.id)"
          >
            <div class="ativo-header">
              {{ ativo.nome }} <span *ngIf="ativosSelecionados.includes(ativo.id)">✅</span>
            </div>
            <div class="ativo-details">
              {{ ativo.descricao }}<br />
              <b>Dose cães:</b> {{ ativo.doseCaes }}<br />
              <b>Dose gatos:</b> {{ ativo.doseGatos }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Assinatura -->
  <div class="card receita-card">
    <h3>Assinatura</h3>
    <div class="assinatura-row">
      <!-- <div class="assinatura-col">
        <label>Assinatura digitada</label>
        <input [(ngModel)]="assinaturaManual" placeholder="Digite sua assinatura" class="input-busca" />

      </div> -->
      <!-- Dados do Veterinário -->
<div *ngIf="veterinario" class="card receita-card">
  <h3>Dados do Veterinário</h3>
  <div class="tutor-grid">
    <div><b>Nome:</b> {{ veterinario.nome }}</div>
    <div><b>CPF:</b> {{ veterinario.cpf }}</div>
    <div><b>CRMV:</b> {{ veterinario.crmv }}</div>
    <div><b>Email:</b> {{ veterinario.email }}</div>
    <div><b>Telefone:</b> {{ veterinario.telefone }}</div>
  </div>
</div>
      <div class="assinatura-col">
        <label>Desenhar assinatura</label>
        <div class="canvas-wrap">
          <canvas
            #canvas
            class="assinatura-canvas"
            width="600"
            height="150"
            (pointerdown)="canvasPointerDown($event)"
            (pointermove)="canvasPointerMove($event)"
            (pointerup)="canvasPointerUp()"
            (pointerleave)="canvasPointerUp()"
            (pointercancel)="canvasPointerUp()"
          ></canvas>
        </div>
        <div class="assinatura-actions">
          <button class="btn" (click)="limparAssinaturaCanvas()">Limpar</button>
        </div>

                <button class="btn" (click)="gerarAssinaturaCursiva(tutorEncontrado?.nome || novoTutor.nome || 'Veterinário')">Gerar assinatura cursiva</button>
      </div>
    </div>
    <div *ngIf="assinaturaICP" class="muted small">Mock ICP: {{ assinaturaICP }}</div>
  </div>

  <!-- Salvar -->
  <div class="rodape">
    <button class="btn" (click)="salvarReceita()">Salvar Receita</button>
    
    <button class="btn" (click)="gerarPdf()">Gerar PDF</button>
  </div>
</div>


<!-- <div #pdfContent class="pdf-container">
  <header class="pdf-header">
    <h1>RECEITA VETERINÁRIA</h1>
  </header>

  <section class="pdf-box">
    <h2>Dados do Veterinário</h2>
    <p><strong>Nome:</strong> {{ veterinario?.nome || '-' }}</p>
    <p><strong>CPF:</strong> {{ veterinario?.cpf || '-' }}</p>
    <p><strong>CRMV:</strong> {{ veterinario?.crmv || '-' }}</p>
    <p><strong>Email:</strong> {{ veterinario?.email || '-' }}</p>
    <p><strong>Telefone:</strong> {{ veterinario?.telefone || '-' }}</p>
  </section>

  <section class="pdf-box">
    <h2>Dados do Tutor</h2>
    <p><strong>Nome:</strong> {{ tutorEncontrado?.nome || novoTutor.nome }}</p>
    <p><strong>CPF:</strong> {{ tutorEncontrado?.cpf || novoTutor.cpf }}</p>
    <p><strong>Telefone:</strong> {{ tutorEncontrado?.telefone || novoTutor.telefone }}</p>
    <p><strong>Email:</strong> {{ tutorEncontrado?.email || novoTutor.email }}</p>
    <p><strong>Endereço:</strong> {{ tutorEncontrado?.endereco || novoTutor.endereco }}</p>
  </section>

  <section class="pdf-box">
    <h2>Dados do Pet</h2>
    <p><strong>Nome:</strong> {{ petSelecionado?.nome || novosDadosPet.nome }}</p>
    <p><strong>Espécie:</strong> {{ petSelecionado?.especie || novosDadosPet.especie }}</p>
    <p><strong>Raça:</strong> {{ petSelecionado?.raca || novosDadosPet.raca }}</p>
    <p><strong>Idade:</strong> {{ petSelecionado?.idade || novosDadosPet.idade }} anos</p>
    <p><strong>Peso:</strong> {{ petSelecionado?.peso || novosDadosPet.peso }} kg</p>
    <p><strong>Sexo:</strong> {{ petSelecionado?.sexo || novosDadosPet.sexo }}</p>
    <p><strong>Alergias:</strong> {{ petSelecionado?.alergias || 'Nenhuma' }}</p>
  </section>

  <section class="pdf-box">
    <h2>Prescrição</h2>
    <table class="pdf-table">
      <thead>
        <tr>
          <th>Medicamento</th>
          <th>Dose Cães</th>
          <th>Dose Gatos</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let id of ativosSelecionados">
          <td>{{ getNomeAtivo(id) }}</td>
            <td>{{ getDoseCaes(id) }}</td>
            <td>{{ getDoseGatos(id) }}</td>

        </tr>
      </tbody>
    </table>
  </section>

  <section class="pdf-box">
    <h2>Observações</h2>
    <p>{{ observacoes || '-' }}</p>
  </section>

  <section class="pdf-signature">
    <h2>Assinatura</h2>
    <img *ngIf="canvasRef?.nativeElement" [src]="canvasRef.nativeElement.toDataURL()" alt="Assinatura" />
    <p *ngIf="!canvasRef?.nativeElement">__________________________</p>
  </section>

  <footer class="pdf-footer">
    Documento gerado digitalmente - Fórmula Pet
  </footer>
</div> -->
<div #pdfContent class="pdf-container" style="position: absolute; left: -9999px; top: -9999px;">
  <header class="pdf-header">
    <h1>RECEITA VETERINÁRIA</h1>
  </header>

  <section class="pdf-box pdf-box-two-columns">
    <div class="col">
      <h2>Dados do Tutor</h2>
      <p><strong>Nome:</strong> {{ tutorEncontrado?.nome || novoTutor.nome }}</p>
      <p><strong>CPF:</strong> {{ tutorEncontrado?.cpf || novoTutor.cpf }}</p>
      <p><strong>Telefone:</strong> {{ tutorEncontrado?.telefone || novoTutor.telefone }}</p>
      <p><strong>Email:</strong> {{ tutorEncontrado?.email || novoTutor.email }}</p>
      <p><strong>Endereço:</strong> {{ tutorEncontrado?.endereco || novoTutor.endereco }}</p>
    </div>
    <div class="col">
      <h2>Dados do Pet</h2>
      <p><strong>Nome:</strong> {{ petSelecionado?.nome || novosDadosPet.nome }}</p>
      <p><strong>Espécie:</strong> {{ petSelecionado?.especie || novosDadosPet.especie }}</p>
      <p><strong>Raça:</strong> {{ petSelecionado?.raca || novosDadosPet.raca }}</p>
      <p><strong>Idade:</strong> {{ petSelecionado?.idade || novosDadosPet.idade }} anos</p>
      <p><strong>Peso:</strong> {{ petSelecionado?.peso || novosDadosPet.peso }} kg</p>
      <p><strong>Sexo:</strong> {{ petSelecionado?.sexo || novosDadosPet.sexo }}</p>
      <p><strong>Alergias:</strong> {{ petSelecionado?.alergias || 'Nenhuma' }}</p>
    </div>
  </section>

  <section class="pdf-box">
    <h2>Prescrição</h2>
    <table class="pdf-table">
      <thead>
        <tr>
          <th>Medicamento</th>
          <th>Dose Cães</th>
          <th>Dose Gatos</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let id of ativosSelecionados">
          <td>{{ getNomeAtivo(id) }}</td>
          <td>{{ getDoseCaes(id) }}</td>
          <td>{{ getDoseGatos(id) }}</td>
        </tr>
      </tbody>
    </table>
  </section>

  <section class="pdf-box">
    <h2>Observações</h2>
    <p style="white-space: pre-wrap;">{{ observacoes || '-' }}</p>
  </section>

  <section class="pdf-box">
    <h2>Dados do Veterinário</h2>
    <p><strong>Nome:</strong> {{ veterinario?.nome || '-' }}</p>
    <p><strong>CPF:</strong> {{ veterinario?.cpf || '-' }}</p>
    <p><strong>CRMV:</strong> {{ veterinario?.crmv || '-' }}</p>
    <p><strong>Email:</strong> {{ veterinario?.email || '-' }}</p>
    <p><strong>Telefone:</strong> {{ veterinario?.telefone || '-' }}</p>

    <section class="pdf-signature">
      <h2>Assinatura</h2>
      <img *ngIf="canvasRef?.nativeElement" [src]="canvasRef.nativeElement.toDataURL()" alt="Assinatura" />
      <p *ngIf="!canvasRef?.nativeElement">__________________________</p>
    </section>
  </section>

  <footer class="pdf-footer">
    Documento gerado digitalmente - Fórmula Pet
  </footer>
</div>
