<div class="area-vet-wrapper">
  <app-navmenu></app-navmenu>
    <div class="acoes-row" style="justify-content: end; padding-top: 5px;">
    <button id="btnTutorialReceita" class="btn-help" type="button" (click)="startTour()" aria-label="Como funciona?">?</button>
  </div>
  <h1 class="titulo">Gerar Receita</h1>

  <!-- CPF -->
  <div class="card receita-card">
    <h3>CPF do Tutor</h3>
    <div class="row">
      <input
        id="cpfInput"
        type="text"
        name="cpf"
        [(ngModel)]="cpf"
        placeholder="000.000.000-00"
        mask="000.000.000-00"
        class="input-busca"
        (input)="onCpfInput()"
      />
      <button id="buscarBtn" class="btn" (click)="buscarTutor()" [disabled]="carregandoTutor">Buscar</button>
    </div>
    <p *ngIf="carregandoTutor" class="muted">Buscando tutor...</p>
  </div>

  <!-- Tutor encontrado -->
  <div *ngIf="tutorEncontrado" class="card receita-card" id="dadosTutor">
    <h3>Dados do Tutor</h3>
    <div class="tutor-grid">
      <div><b>Nome:</b> {{ tutorEncontrado.nome }}</div>
      <div><b>CPF:</b> {{ tutorEncontrado.cpf }}</div>
      <div><b>Telefone:</b> {{ tutorEncontrado.telefone }}</div>
      <div><b>Email:</b> {{ tutorEncontrado.email }}</div>
      <div class="full"><b>Endereço:</b> {{ tutorEncontrado.endereco }}</div>
    </div>

    <!-- Pets -->
    <h4 class="subtitulo">Pets Cadastrados</h4>
  <div class="cards-da-letra" id="listaPets" *ngIf="tutorEncontrado.pets?.length; else semPets">
      <div
        *ngFor="let pet of tutorEncontrado.pets; trackBy: trackByPet"
        class="pet-card"
        [class.selected]="petSelecionado?.id === pet.id"
        (click)="selecionarPet(pet)"
      >
        <div class="ativo-header">{{ pet.nome }} <small class="muted">({{ pet.sexo }})</small>
          <span class="pet-status" *ngIf="isPetPendente(pet)">Pendente de aceitação</span>
        </div>
        <div class="ativo-details">
          Idade: {{ pet.idade }} anos<br />
          Peso: {{ pet.peso }} kg<br />
          Raça: {{ pet.raca }}<br />
          <div *ngIf="pet.alergias?.length" class="alergias-wrapper">
            <div class="alergias-label"><strong>Alergias:</strong></div>
            <div class="ativos-badges">
              <span class="badge" *ngFor="let a of pet.alergias">{{ a }}</span>
            </div>
          </div>
          <div *ngIf="pet.alergias && !pet.alergias.length">Alergias: Nenhuma</div>
          Espécie: {{ pet.especie}}
        </div>
      </div>
    </div>
    <ng-template #semPets>
      <div class="muted">Nenhum pet encontrado para este tutor.</div>
    </ng-template>
  </div>

  <!-- Cadastro manual do tutor -->
  <div *ngIf="cadastroManualTutor" class="card receita-card">
    <h3>Cadastro Manual do Tutor</h3>
    <div class="grid-pet">
      <input [(ngModel)]="novoTutor.nome" placeholder="Nome completo" class="input-busca" />
      <input [(ngModel)]="novoTutor.telefone" placeholder="Telefone" class="input-busca" />
      <input [(ngModel)]="novoTutor.email" placeholder="E-mail" class="input-busca" />
      <input [(ngModel)]="novoTutor.endereco" placeholder="Endereço" class="input-busca" />
    </div>
  </div>

<!-- Novo Pet -->
  <div class="card receita-card" id="dadosPet">
    <h3>Dados do Pet</h3>
    <div class="grid-pet">
        <div class="input-group">
        <label>Nome do Pet</label>
  <input [(ngModel)]="novosDadosPet.nome" (ngModelChange)="onPetFieldChange()" placeholder="Nome do Pet" class="input-busca" />
        </div>

        <div class="input-group">
        <label>Idade (anos)</label>
  <input [(ngModel)]="novosDadosPet.idade" (ngModelChange)="onPetFieldChange()" placeholder="Idade" type="number" class="input-busca" />
        </div>

        <div class="input-group">
        <label>Peso (kg)</label>
  <input [(ngModel)]="novosDadosPet.peso" (ngModelChange)="onPetFieldChange()" placeholder="Peso" type="number" class="input-busca" />
        </div>

        <div class="input-group">
        <label>Raça</label>
  <input [(ngModel)]="novosDadosPet.raca" (ngModelChange)="onPetFieldChange()" placeholder="Raça" class="input-busca" />
        </div>

        <div class="input-group">
        <label>Espécie</label>
  <input [(ngModel)]="novosDadosPet.especie" (ngModelChange)="onPetFieldChange()" placeholder="Ex: Cachorro, Gato" class="input-busca" />
        </div>

        <div class="input-group">
        <label>Sexo</label>
  <select [(ngModel)]="novosDadosPet.sexo" (ngModelChange)="onPetFieldChange()" class="input-busca">
            <option value="Macho">Macho</option>
            <option value="Fêmea">Fêmea</option>
        </select>
        </div>

        <div class="input-group">
          <label>Alergias</label>
          <div class="row" style="align-items: stretch; gap:8px; flex-wrap: wrap;">
            <input id="alergiasVet" [(ngModel)]="alergiaBuscaVet" (input)="filtrarSugestoesVet()" placeholder="Busque e selecione..." class="input-busca" />
          </div>
          <div class="dropdown" *ngIf="showSugestoesVet">
            <div class="option" *ngFor="let s of sugestoesVet" (click)="adicionarSugestaoVet(s)">{{ s.nome }}</div>
          </div>
          <div class="ativos-badges" *ngIf="alergiasSelecionadasVet.length">
            <span class="badge" *ngFor="let sel of alergiasSelecionadasVet; let i = index">
              {{ sel.nome }}
              <button class="badge-remove" type="button" (click)="removerAlergiaVet(i)">x</button>
            </span>
          </div>
        </div>
    </div>
    </div>


  <!-- Observações -->
  <div class="card receita-card">
    <h3>Observações</h3>
    <textarea [(ngModel)]="observacoes" placeholder="Digite aqui observações da receita..." class="input-busca"></textarea>
  </div>

  <!-- Ativos -->
  <div class="card receita-card" id="ativosCard">
    <h3>Selecionar Ativos</h3>
    <div class="ativos-controls">
      <input id="ativosSearch" type="text" [(ngModel)]="ativosSearch" (ngModelChange)="onAtivosSearchChange()" placeholder="Pesquisar ativo..." class="input-busca" />
      <div class="muted small">Total: {{ ativos.length }}</div>
      <button id="btnExibirTodosAtivos" class="btn-toggle" (click)="toggleTodosAtivos()">{{ showAllAtivos ? 'Ocultar medicamentos' : 'Exibir todos' }}</button>
    </div>

    <div class="ativos-badges" *ngIf="ativosSelecionados.length">
      <span class="badge" *ngFor="let id of ativosSelecionados">
        {{ getNomeAtivo(id) }}
        <button class="badge-remove" (click)="toggleAtivo(id)">x</button>
      </span>
    </div>
    <div class="muted small" *ngIf="alerta_alergia">Alerta de alergia confirmado para pelo menos um ativo selecionado.</div>

  <div id="listaAtivos" *ngFor="let grupo of alfabetico">
      <div *ngIf="!isGrupoColapsado(grupo.letra)">
        <div class="grupo-header" (click)="toggleGrupo(grupo.letra)">
          <h4 class="indice-letra">{{ grupo.letra }}</h4>
        </div>

        <div class="cards-da-letra">
          <div
            class="ativo-item"
            *ngFor="let ativo of grupo.ativos; trackBy: trackByAtivo"
            (click)="toggleAtivo(ativo.id)"
            [class.selected]="ativosSelecionados.includes(ativo.id)"
          >
            <div class="ativo-header">
              <span [innerHTML]="highlight(ativo.nome)"></span> <span *ngIf="ativosSelecionados.includes(ativo.id)">✅</span>
            </div>
            <div class="ativo-details">
              <span [innerHTML]="highlight(ativo.descricao)"></span><br />
              <b>Dose cães:</b> {{ ativo.doseCaes }}<br />
              <b>Dose gatos:</b> {{ ativo.doseGatos }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Assinatura -->
  <div class="card receita-card" id="assinaturaSec">
    <h3>Assinatura</h3>
    <div class="assinatura-row">
      <div *ngIf="veterinario" class="card receita-card vet-card">
        <h3>Dados do Veterinário</h3>
        <div class="tutor-grid">
          <div><b>Nome:</b> {{ veterinario.nome }}</div>
          <div><b>CPF:</b> {{ veterinario.cpf }}</div>
          <div><b>CRMV:</b> {{ veterinario.crmv }}</div>
          <div><b>Email:</b> {{ veterinario.email }}</div>
          <div><b>Telefone:</b> {{ veterinario.telefone }}</div>
          <div><b>Assinatura gerada digitalmente - Certificado ICP-Brasil </b></div>
        </div>
      </div>
      <div class="assinatura-col">
        <div class="row" style="justify-content: space-between; align-items: center; gap: 12px;">
          <label>Desenhar assinatura (Opcional)</label>
          <button type="button" class="btn-toggle" (click)="toggleSignatureCanvas()">
            {{ showSignatureCanvas ? 'Ocultar' : 'Mostrar' }}
          </button>
          <button *ngIf="isMobile" type="button" class="btn-ghost" (click)="abrirAssinaturaFullscreen()">Tela cheia</button>
        </div>
        <div class="canvas-wrap" *ngIf="showSignatureCanvas">
          <canvas *ngIf="isBrowser"
            #canvas
            class="assinatura-canvas"
            width="600"
            height="200"
            (pointerdown)="canvasPointerDown($event)"
            (pointermove)="canvasPointerMove($event)"
            (pointerup)="canvasPointerUp()"
            (pointerleave)="canvasPointerUp()"
            (pointercancel)="canvasPointerUp()"
          ></canvas>
        </div>
        <div class="assinatura-actions" *ngIf="showSignatureCanvas">
          <button class="btn" (click)="limparAssinaturaCanvas()">Limpar</button>
        </div>

                <!-- <button class="btn" (click)="gerarAssinaturaCursiva(veterinario.nome)">Gerar assinatura cursiva</button> -->
      </div>
    </div>
    <div *ngIf="assinaturaICP" class="muted small">Mock ICP: {{ assinaturaICP }}</div>
  </div>

  <!-- Salvar -->
  <div class="rodape">
    <button id="salvarReceitaBtn" class="btn" (click)="salvarReceita()">Salvar Receita</button>
  </div>

  <!-- Modal: Escolha de ação para edição do pet -->
  <div class="modal-backdrop" *ngIf="showPetEditModal" (click)="fecharModalEditarPet()"></div>
  <div class="modal-card" *ngIf="showPetEditModal" (click)="$event.stopPropagation()">
    <h3>Como deseja salvar as alterações do pet?</h3>
     <div class="modal-actions">
      <button class="btn" (click)="onEscolhaEdicaoPet('novo')">Cadastrar novo pet</button>
      <button class="btn" (click)="onEscolhaEdicaoPet('editar')" [disabled]="!petSelecionado?.id">Editar pet existente</button>
      <button class="btn-sec" (click)="onEscolhaEdicaoPet('cancelar')">Cancelar</button>
    </div>
  </div>

  <!-- Modal: Alerta de alergia ao incluir ativo -->
  <div class="modal-backdrop" *ngIf="showAlergiaModal" (click)="cancelarAlergiaAtivo()"></div>
  <div class="modal-card modal-alert" *ngIf="showAlergiaModal" (click)="$event.stopPropagation()">
    <div class="alert-row">
      <div class="alert-icon">!</div>
      <div>
        <h3>Esse pet é alérgico a esse medicamento.</h3>
        <p class="muted">Tem certeza que deseja incluir o ativo mesmo assim?</p>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" (click)="confirmarAlergiaAtivo()">Incluir mesmo assim</button>
      <button class="btn-sec" (click)="cancelarAlergiaAtivo()">Cancelar</button>
    </div>
  </div>
</div>

<div #pdfContent class="pdf-container pdf-watermark" style="position: absolute; left: -9999px; top: -9999px;">

  <header class="pdf-header">
    <img src="imagens/logo-farmacia.png" alt="Logo Fórmula Pet" class="pdf-logo" />
    <h1>Receita Veterinária</h1>
  </header>

  <!-- Tutor -->
  <section class="pdf-box">

    <div>      
      <h2>Dados do Tutor</h2>
      <p><strong>Nome:</strong> {{ tutorEncontrado?.nome || novoTutor.nome }}</p>
      <p><strong>CPF:</strong> {{ tutorEncontrado?.cpf || novoTutor.cpf }}</p>
      <p><strong>Telefone:</strong> {{ tutorEncontrado?.telefone || novoTutor.telefone }}</p>
      <p><strong>Email:</strong> {{ tutorEncontrado?.email || novoTutor.email }}</p>
      <p><strong>Endereço:</strong> {{ tutorEncontrado?.endereco || novoTutor.endereco }}</p>
    </div>
    
    <div>
      <h2>{{ petSelecionado?.nome || novosDadosPet.nome }}</h2>
      <p class="pet-basic">
        {{ petSelecionado?.especie || novosDadosPet.especie }}
        ({{ petSelecionado?.raca || novosDadosPet.raca }})
        <span class="pet-gender" 
        [ngClass]="{'male': (petSelecionado?.sexo || novosDadosPet.sexo) === 'Macho', 
                        'female': (petSelecionado?.sexo || novosDadosPet.sexo) === 'Fêmea'}">
        {{ (petSelecionado?.sexo || novosDadosPet.sexo) === 'Macho' ? '♂' : '♀' }}
      </span>
      - {{ petSelecionado?.peso || novosDadosPet.peso }}kg
      - {{ petSelecionado?.idade || novosDadosPet.idade }} anos
    </p>
  </div>

  </section>

  <!-- Pet -->
  <section class="pdf-box pdf-pet-info" *ngIf="(petSelecionado?.alergias || novosDadosPet.alergias)">
    <div  class="pet-allergies">
      <strong>Alergias:</strong> {{ petSelecionado?.alergias || novosDadosPet.alergias }}
    </div>
  </section>

  <!-- Prescrição -->
  <section class="pdf-box">
    <h2>Prescrição</h2>
    <table class="pdf-table">
      <thead>
        <tr>
          <th>Medicamento</th>
          <th>Dose Cães</th>
          <th>Dose Gatos</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let id of ativosSelecionados">
          <td>{{ getNomeAtivo(id) }}</td>
          <td>{{ getDoseCaes(id) }}</td>
          <td>{{ getDoseGatos(id) }}</td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- Observações -->
  <section class="pdf-box">
    <h2>Observações</h2>
    <p style="white-space: pre-wrap;">{{ observacoes || '-' }}</p>
  </section>

  <!-- Veterinário + Assinatura -->
  <section class="pdf-box pdf-vet-signature">
    <div class="vet-info">
      <h2>Dados do Veterinário</h2>
      <p><strong>Nome:</strong> {{ veterinario?.nome || '-' }}</p>
      <p><strong>CPF:</strong> {{ veterinario?.cpf || '-' }} - <strong>CRMV:</strong> {{ veterinario?.crmv || '-' }}</p>
      <p><strong>Email:</strong> {{ veterinario?.email || '-' }} | <strong>Tel:</strong> {{ veterinario?.telefone || '-' }}</p>
    </div>
    <div class="signature-box">
      <h2>Assinatura</h2>
      <img *ngIf="canvasRef?.nativeElement" [src]="canvasRef.nativeElement.toDataURL()" alt="Assinatura" />
      <p *ngIf="!canvasRef?.nativeElement">__________________________</p>
      <p>{{ veterinario?.nome || '-' }}</p>
    </div>
  </section>

  <footer class="pdf-footer">
    <img src="imagens/image.png" alt="" class="pdf-logo-footer">
    <p>Documento gerado digitalmente - Fórmula Pet</p>
  </footer>
</div>

<!-- Assinatura em Tela Cheia -->
<div class="fs-backdrop" *ngIf="showSignatureFullscreen && isMobile" (click)="cancelarAssinaturaFullscreen()"></div>
<div class="fs-panel" *ngIf="showSignatureFullscreen && isMobile" (click)="$event.stopPropagation()">
  <div class="fs-canvas-wrap">
    <canvas *ngIf="isBrowser"
      #fsCanvas
      class="fs-canvas"
      (pointerdown)="fsPointerDown($event)"
      (pointermove)="fsPointerMove($event)"
      (pointerup)="fsPointerUp()"
      (pointerleave)="fsPointerUp()"
      (pointercancel)="fsPointerUp()"
    ></canvas>
  </div>
  <div class="fs-sidebar">
    <div class="fs-side-inner">
      <div class="fs-actions">
        <button class="btn-sec" (click)="limparFsCanvas()">Limpar</button>
        <button class="btn-sec" (click)="cancelarAssinaturaFullscreen()">Cancelar</button>
        <button class="btn btn-rotate" (click)="confirmarAssinaturaFullscreen()">
          <span class="rotate-label">Concluir</span>
          <span class="rotate-indicator" aria-hidden="true">↻</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Guided Tour overlays -->
<div *ngIf="showTour" class="tour-highlight" [ngStyle]="tourHighlightStyle"></div>
<!-- Scrim blocks interactions but does not close the tour on outside click -->
<div *ngIf="showTour" class="tour-scrim" (click)="$event.stopPropagation()"></div>
<div *ngIf="showTour" class="tour-popover" [ngStyle]="tourPopoverStyle" (click)="$event.stopPropagation()">
  <div class="tour-title">{{ tourSteps[tourIndex].title }}</div>
  <div class="tour-text">{{ tourSteps[tourIndex].text }}</div>
  <div class="tour-actions">
    <button type="button" class="btn-sec" (click)="prevTour()" [disabled]="tourIndex===0">Voltar</button>
    <div class="spacer"></div>
    <button type="button" class="btn-sec" (click)="endTour()">Fechar</button>
    <button type="button" class="btn" (click)="nextTour()">{{ tourIndex === tourSteps.length - 1 ? 'Concluir' : 'Próximo' }}</button>
  </div>
  <div class="tour-step-indicator">Passo {{ tourIndex + 1 }} de {{ tourSteps.length }}</div>
  <div class="tour-arrow"></div>
</div>


