<div class="dash-layout">
  <aside class="sidebar">
    <div class="brand">Admin</div>
    <nav>
      <button [class.active]="section()==='resumo'" (click)="section.set('resumo'); reload()">Resumo</button>
      <button [class.active]="section()==='vendas'" (click)="section.set('vendas'); reload()">Vendas</button>
      <button [class.active]="section()==='marketplace'" (click)="section.set('marketplace'); reload()">Marketplace</button>
      <button [class.active]="section()==='clientes'" (click)="section.set('clientes'); reload()">Clientes</button>
      <button [class.active]="section()==='promocoes'" (click)="section.set('promocoes'); reload()">Promoções</button>
      <button [class.active]="section()==='cupons'" (click)="section.set('cupons'); reload()">Cupons</button>
    </nav>
    <div class="theme">
      <label>Tema</label>
      <button class="btn ghost" (click)="toggleTheme()">{{ theme()==='light' ? 'Claro' : 'Escuro' }}</button>
    </div>
  </aside>
  <main class="content">
    <header class="toolbar">
      <h1>Dashboard · {{ section() | titlecase }}</h1>
      <div class="filters">
        <input type="date" [ngModel]="from()" (ngModelChange)="onFromChange($event)" />
        <input type="date" [ngModel]="to()" (ngModelChange)="onToChange($event)" />
        <select [ngModel]="sortDir()" (ngModelChange)="onSortDirChange($event)">
          <option value="desc">Desc</option>
          <option value="asc">Asc</option>
        </select>
        <select [ngModel]="limit()" (ngModelChange)="onLimitChange($event)">
          <option value="">Sem limite</option>
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
        <button class="btn refresh" (click)="reload()">Atualizar</button>
      </div>
    </header>

    <div *ngIf="error()" class="error">{{ error() }}</div>
    <ng-container *ngIf="data() as d">
      <section *ngIf="section()==='resumo'">
        <!-- KPIs (novo payload) -->
        <section class="kpis">
          <div class="kpi"><span>Receita total</span><strong>{{ (d.kpis?.total_revenue || d.sales?.total_revenue || 0) | currency:'BRL':'symbol-narrow' }}</strong></div>
          <div class="kpi"><span>Pedidos</span><strong>{{ d.kpis?.total_orders || d.sales?.total_orders || 0 }}</strong></div>
          <div class="kpi"><span>Itens</span><strong>{{ d.kpis?.total_items || d.sales?.total_items || 0 }}</strong></div>
          <div class="kpi"><span>Ticket médio</span><strong>{{ (d.kpis?.avg_ticket || 0) | currency:'BRL':'symbol-narrow' }}</strong></div>
          <div class="kpi"><span>Receita promo</span><strong>{{ (d.kpis?.promo_revenue || 0) | currency:'BRL':'symbol-narrow' }}</strong></div>
          <div class="kpi"><span>Itens promo</span><strong>{{ d.kpis?.promo_items || 0 }}</strong></div>
          <div class="kpi"><span>Share promo</span><strong>{{ d.kpis?.promo_share || 0 | number:'1.0-2' }}%</strong></div>
          <div class="kpi"><span>Desconto total</span><strong>{{ (d.kpis?.desconto_total || 0) | currency:'BRL':'symbol-narrow' }}</strong></div>
          <div class="kpi"><span>Pedidos c/ cupom</span><strong>{{ d.kpis?.pedidos_com_cupom || 0 }}</strong></div>
          <div class="kpi"><span>Clientes únicos</span><strong>{{ d.kpis?.unique_customers || 0 }}</strong></div>
          <div class="kpi"><span>Novos clientes</span><strong>{{ d.kpis?.novos_clientes || 0 }}</strong></div>
          <div class="kpi"><span>Recorrentes</span><strong>{{ d.kpis?.recorrentes_clientes || 0 }}</strong></div>
        </section>
        <!-- Resumo: Vendas 30 dias -->
        <section class="charts one">
          <div class="panel">
            <h3>Vendas (30 dias)</h3>
            <div class="chart-box">
              <canvas id="chart-resumo-sales-30d" *ngIf="(d?.sales_30d?.by_day?.length || 0) > 0"></canvas>
              <div class="empty" *ngIf="!((d?.sales_30d?.by_day?.length))">Sem dados</div>
            </div>
          </div>
        </section>
        <!-- Cards -->
        <section class="grid-cards">
          <div class="card">
            <h3>Marketplace</h3>
            <ul>
              <li>Produtos: <strong>{{ (d.highlights?.marketplace?.produtos || d.marketplace?.totals?.produtos || 0) }}</strong></li>
              <li>Ativos: <strong>{{ (d.highlights?.marketplace?.ativos || d.marketplace?.totals?.ativos || 0) }}</strong></li>
              <li>Inativos: <strong>{{ (d.highlights?.marketplace?.inativos || d.marketplace?.totals?.inativos || 0) }}</strong></li>
            </ul>
          </div>
          <div class="card">
            <h3>Promoções</h3>
            <ul>
              <li>Ativas: <strong>{{ d.highlights?.promotions?.active || d.promotions?.active || 0 }}</strong></li>
            </ul>
          </div>
          <div class="card">
            <h3>Cupons</h3>
            <ul>
              <li>Ativos: <strong>{{ d.highlights?.coupons?.active || 0 }}</strong></li>
            </ul>
          </div>
          <div class="card">
            <h3>Snapshots</h3>
            <ul>
              <li>Hoje: <strong>{{ (d.snapshots?.today?.revenue || 0) | currency:'BRL':'symbol-narrow' }}</strong> · {{ d.snapshots?.today?.orders || 0 }} pedidos</li>
              <li>7 dias: <strong>{{ (d.snapshots?.last_7d?.revenue || 0) | currency:'BRL':'symbol-narrow' }}</strong> · {{ d.snapshots?.last_7d?.orders || 0 }} pedidos</li>
              <li>30 dias: <strong>{{ (d.snapshots?.last_30d?.revenue || 0) | currency:'BRL':'symbol-narrow' }}</strong> · {{ d.snapshots?.last_30d?.orders || 0 }} pedidos</li>
            </ul>
          </div>
        </section>

        <!-- Breakdowns (tables for quick scan) -->
        <section class="charts two" *ngIf="d.breakdowns">
          <div class="panel">
            <h3>Por pagamento</h3>
            <div class="table-wrap small">
              <table>
                <thead><tr><th>Forma</th><th>Pedidos</th><th>Receita</th></tr></thead>
                <tbody>
                  <tr *ngFor="let p of d.breakdowns?.by_payment">
                    <td>{{ p.pagamento_forma }}</td>
                    <td>{{ p.pedidos }}</td>
                    <td>{{ (p.receita || 0) | currency:'BRL':'symbol-narrow' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="panel">
            <h3>Por status</h3>
            <div class="table-wrap small">
              <table>
                <thead><tr><th>Status</th><th>Pedidos</th></tr></thead>
                <tbody>
                  <tr *ngFor="let s of d.breakdowns?.by_status">
                    <td>{{ s.status }}</td>
                    <td>{{ s.pedidos }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Top lists -->
        <section class="charts three" *ngIf="d.top">
          <div class="panel">
            <h3>Top produtos</h3>
            <div class="table-wrap small">
              <table>
                <thead><tr><th>Produto</th><th>Receita</th><th>Itens</th></tr></thead>
                <tbody>
                  <tr *ngFor="let p of d.top?.products">
                    <td>{{ p.nome }}</td>
                    <td>{{ (p.receita || 0) | currency:'BRL':'symbol-narrow' }}</td>
                    <td>{{ p.itens }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="panel">
            <h3>Top categorias</h3>
            <div class="table-wrap small">
              <table>
                <thead><tr><th>Categoria</th><th>Receita</th><th>Itens</th></tr></thead>
                <tbody>
                  <tr *ngFor="let c of d.top?.categories">
                    <td>{{ c.nome }}</td>
                    <td>{{ (c.receita || 0) | currency:'BRL':'symbol-narrow' }}</td>
                    <td>{{ c.itens }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="panel">
            <h3>Top tags</h3>
            <div class="table-wrap small">
              <table>
                <thead><tr><th>Tag</th><th>Receita</th><th>Itens</th></tr></thead>
                <tbody>
                  <tr *ngFor="let t of d.top?.tags">
                    <td>{{ t.nome }}</td>
                    <td>{{ (t.receita || 0) | currency:'BRL':'symbol-narrow' }}</td>
                    <td>{{ t.itens }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </section>

      <section *ngIf="section()==='vendas'">
        <section class="charts two">
          <div class="panel"><h3>Vendas por dia</h3><div class="chart-box"><canvas id="chart-sales-by-day" *ngIf="(d?.by_day?.length || d?.sales?.by_day?.length || 0) > 0"></canvas><div class="empty" *ngIf="!((d?.by_day?.length || d?.sales?.by_day?.length))">Sem dados</div></div></div>
          <div class="panel"><h3>Vendas por tipo</h3><div class="chart-box"><canvas id="chart-sales-by-tipo" *ngIf="(d?.by_tipo?.length || d?.sales?.by_tipo?.length || 0) > 0"></canvas><div class="empty" *ngIf="!((d?.by_tipo?.length || d?.sales?.by_tipo?.length))">Sem dados</div></div></div>
        </section>
        <section class="charts two">
          <div class="panel"><h3>Por pagamento</h3><div class="chart-box"><canvas id="chart-sales-by-payment" *ngIf="(d?.by_payment?.length || d?.sales?.by_payment?.length || 0) > 0"></canvas><div class="empty" *ngIf="!((d?.by_payment?.length || d?.sales?.by_payment?.length))">Sem dados</div></div></div>
          <div class="panel"><h3>Por status</h3><div class="chart-box"><canvas id="chart-sales-by-status" *ngIf="(d?.by_status?.length || d?.sales?.by_status?.length || 0) > 0"></canvas><div class="empty" *ngIf="!((d?.by_status?.length || d?.sales?.by_status?.length))">Sem dados</div></div></div>
        </section>
        <section class="charts two">
          <div class="panel"><h3>Top produtos promo</h3><div class="chart-box"><canvas id="chart-sales-top-promo-products" *ngIf="(d?.top_promo_products?.length || d?.sales?.top_promo_products?.length || 0) > 0"></canvas><div class="empty" *ngIf="!((d?.top_promo_products?.length || d?.sales?.top_promo_products?.length))">Sem dados</div></div></div>
          <div class="panel"><h3>Top produtos</h3><div class="chart-box"><canvas id="chart-sales-top-products" *ngIf="(d?.top_products?.length || d?.sales?.top_products?.length || 0) > 0"></canvas><div class="empty" *ngIf="!((d?.top_products?.length || d?.sales?.top_products?.length))">Sem dados</div></div></div>
        </section>
        <section class="charts two">
          <div class="panel"><h3>Top categorias</h3><div class="chart-box"><canvas id="chart-sales-top-categories" *ngIf="(d?.top_categories?.length || d?.sales?.top_categories?.length || 0) > 0"></canvas><div class="empty" *ngIf="!((d?.top_categories?.length || d?.sales?.top_categories?.length))">Sem dados</div></div></div>
          <div class="panel"><h3>Top tags</h3><div class="chart-box"><canvas id="chart-sales-top-tags" *ngIf="(d?.top_tags?.length || d?.sales?.top_tags?.length || 0) > 0"></canvas><div class="empty" *ngIf="!((d?.top_tags?.length || d?.sales?.top_tags?.length))">Sem dados</div></div></div>
        </section>
      </section>

      <section *ngIf="section()==='marketplace'">
        <section class="charts two">
          <div class="panel"><h3>Marketplace por tipo</h3><div class="chart-box"><canvas id="chart-marketplace-por-tipo" *ngIf="(d?.totals?.por_tipo?.length || d?.marketplace?.totals?.por_tipo?.length || 0) > 0"></canvas><div class="empty" *ngIf="!((d?.totals?.por_tipo?.length || d?.marketplace?.totals?.por_tipo?.length))">Sem dados</div></div></div>
          <div class="panel"><h3>Resumo</h3>
            <ul>
              <li>Produtos: <strong>{{ (d?.totals?.produtos || d?.marketplace?.totals?.produtos || 0) }}</strong></li>
              <li>Ativos: <strong>{{ (d?.totals?.ativos || d?.marketplace?.totals?.ativos || 0) }}</strong></li>
              <li>Inativos: <strong>{{ (d?.totals?.inativos || d?.marketplace?.totals?.inativos || 0) }}</strong></li>
            </ul>
          </div>
        </section>
      </section>

      <section *ngIf="section()==='clientes'">
        <section class="charts two">
          <div class="panel"><h3>Clientes por estado</h3><div class="chart-box"><canvas id="chart-customers-by-state" *ngIf="(d?.by_state?.length || d?.customers_geo?.by_state?.length || 0) > 0"></canvas><div class="empty" *ngIf="!((d?.by_state?.length || d?.customers_geo?.by_state?.length))">Sem dados</div></div></div>
          <div class="panel"><h3>Mapa de pedidos</h3>
            <div class="map-wrap" *ngIf="(d?.by_state?.length || d?.customers_geo?.by_state?.length || 0) > 0; else noGeo">
              <div class="map-grid" *ngIf="byUF({ customers_geo: { by_state: d.by_state || d.customers_geo?.by_state } }) as m">
                <div class="row" *ngFor="let row of getMapRows()">
                  <div class="tile" *ngFor="let uf of row"
                       [attr.title]="uf + ' - ' + (m[uf].pedidos || 0) + ' pedidos'"
                       [style.background]="colorFor(m[uf].pedidos || 0, maxPedidos({ customers_geo: { by_state: d.by_state || d.customers_geo?.by_state } }))">
                    <div class="uf">{{ uf }}</div>
                    <div class="val">{{ m[uf].pedidos || 0 }}</div>
                  </div>
                </div>
              </div>
              <div class="legend"><span>0</span><div class="bar"></div><span>máx</span></div>
            </div>
            <ng-template #noGeo><div class="empty">Sem dados</div></ng-template>
          </div>
        </section>
      </section>

      <section *ngIf="section()==='promocoes'">
        <section class="charts one">
          <div class="panel"><h3>Top produtos em promoção</h3><div class="chart-box"><canvas id="chart-sales-top-promo-products" *ngIf="(d?.top_promo_products?.length || d?.sales?.top_promo_products?.length || 0) > 0"></canvas><div class="empty" *ngIf="!((d?.top_promo_products?.length || d?.sales?.top_promo_products?.length))">Sem dados</div></div></div>
        </section>
      </section>

      <section *ngIf="section()==='cupons'">
        <section class="charts one">
          <div class="panel"><h3>Cupons (desconto total)</h3><div class="chart-box"><canvas id="chart-coupons-top" *ngIf="(d?.top?.length || d?.coupons?.top?.length || 0) > 0"></canvas><div class="empty" *ngIf="!((d?.top?.length || d?.coupons?.top?.length))">Sem dados</div></div></div>
        </section>
      </section>
    </ng-container>
  </main>
  <!-- Loading overlay modal to avoid white background while loading -->
  <div class="loading-overlay" *ngIf="loading()">
    <div class="loader">
      <div class="spinner"></div>
      <div>Carregando dashboard…</div>
    </div>
  </div>
</div>

