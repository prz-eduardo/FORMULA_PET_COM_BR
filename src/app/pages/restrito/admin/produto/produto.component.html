<div class="produto-container" [formGroup]="form">
  <div class="header">
    <h2>{{ form.value.id ? 'Editar Produto' : 'Cadastrar Produto' }}</h2>
    <div class="stepper">
      <button type="button" *ngFor="let s of steps; let i = index"
              [class.active]="step()===i" [class.done]="i<step()"
              (click)="goToStep(i)">{{i+1}}. {{s.label}}</button>
    </div>
  </div>

  <!-- STEP 0: Imagem (obrigatória) -->
  <section *ngIf="step()===0" class="step step-imagem">
    <div class="image-upload">
      <label for="imgUpload">
        <div class="img-preview" *ngIf="form.value.image; else placeholder">
          <img [src]="form.value.image" alt="Imagem do produto">
        </div>
        <ng-template #placeholder>
          <div class="img-placeholder">Clique para adicionar imagem</div>
        </ng-template>
      </label>
      <input type="file" id="imgUpload" (change)="onImageSelected($event)">
      <div class="hint">A imagem é obrigatória para cadastrar o produto.</div>
    </div>
  </section>

  <!-- STEP 1: Fórmula (opcional) -->
  <section *ngIf="step()===1" class="step step-formula">
    <div class="image-upload">
      <label for="imgUpload">
        <div class="img-preview" *ngIf="form.value.image; else placeholder">
          <img [src]="form.value.image" alt="Imagem do produto">
        </div>
        <ng-template #placeholder>
          <div class="img-placeholder">Clique para adicionar imagem</div>
        </ng-template>
      </label>
      <input type="file" id="imgUpload" (change)="onImageSelected($event)">
    </div>

    <div class="form-group full-width">
      <label>Este produto usa uma fórmula?</label>
      <input type="text" placeholder="Buscar fórmula (nome ou forma)"
        [value]="formulaQuery()"
        (input)="onFormulaQueryInput($any($event.target).value)" />
      <div class="sugestoes" *ngIf="(formulasFiltered?.length || 0) > 0">
        <div class="sugestao" (click)="onFormulaChange(null); form.patchValue({ formulaId: null })">
          Não, é um produto pronto
        </div>
        <div class="sugestao" *ngFor="let f of formulasFiltered"
             (click)="form.patchValue({ formulaId: f.id }); onFormulaChange(f.id)">
          {{ f.name }} <span class="muted">• {{ f.form_name || '—' }}</span>
        </div>
      </div>
      <div class="hint">Se escolher uma fórmula, vamos buscar os estoques dos ativos dessa fórmula para vincular um lote.</div>
    </div>

    <div class="form-group full-width" *ngIf="form.value.formulaId">
      <div class="hint" *ngIf="formulaStatus.missing?.length">Ativos sem lote disponível: {{ missingLabel() }}</div>
      <div class="availability" *ngIf="formulaStatus.items?.length">
        <div class="availability-grid">
          <div class="avail-row header">
            <div>Ativo</div>
            <div>Req/Unidade</div>
            <div>Disponível (conv.)</div>
            <div>Unidades producíveis</div>
          </div>
          <div class="avail-row" *ngFor="let it of formulaStatus.items">
            <div>{{ it.ativo_nome }}</div>
            <div>{{ it.required_per_unit }} {{ it.unit_code }}</div>
            <div>{{ it.available_converted }} {{ it.unit_code }}</div>
            <div>{{ it.producible_units }}</div>
          </div>
        </div>
      </div>
      <div class="lots-by-ativo" *ngIf="formulaStatus.lotsByAtivo | keyvalue as kv">
        <div class="ativo-block" *ngFor="let entry of kv">
          <h5>Ativo #{{ entry.key }}</h5>
          <div class="estoque-list">
            <div class="lote-card" *ngFor="let e of entry.value" (click)="selecionarLote(e)" [class.selected]="estoqueSelecionado?.id === e.id">
              <div class="lote-select">
                <div class="meta">
                  <div><strong>Lote:</strong> {{ e.lote || '—' }}</div>
                  <div><strong>Qtd:</strong> {{ e.quantity }} {{ e.unit_code }}</div>
                  <div><strong>Validade:</strong> {{ e.validade || '—' }}</div>
                  <div class="muted">#{{ e.id }} • {{ e.unit_name || e.unit_code }} • {{ e.location || '—' }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <label>Selecionar Lote de Estoque (obrigatório quando há fórmula)</label>
      <div class="estoque-list" *ngIf="estoqueLotes.length; else semEstoqueFormula">
        <div class="lote-card" *ngFor="let e of estoqueLotes" (click)="selecionarLote(e)"
             [class.selected]="estoqueSelecionado?.id === e.id">
          <div class="lote-select">
            <div class="meta">
              <div><strong>Lote:</strong> {{ e.lote || '—' }}</div>
              <div><strong>Qtd:</strong> {{ e.quantity }} {{ e.unit_code }}</div>
              <div><strong>Validade:</strong> {{ e.validade || '—' }}</div>
              <div class="muted">#{{ e.id }} • {{ e.unit_name || e.unit_code }} • {{ e.location || '—' }}</div>
            </div>
          </div>
        </div>
      </div>
      <ng-template #semEstoqueFormula>
        <div class="empty">
          Nenhum lote encontrado nos ativos da fórmula. Cadastre estoque antes de prosseguir.
          <button type="button" class="link" (click)="router.navigate(['/restrito/admin/estoque'])">+ Cadastrar Estoque</button>
        </div>
      </ng-template>
    </div>
  </section>

  <!-- STEP 2: Básico -->
  <section *ngIf="step()===2" class="step step-basico">
    <div class="form-grid">
      <div class="form-group">
        <label>Tipo do Produto</label>
        <select formControlName="tipo" required>
          <option value="pronto">Pronto</option>
          <option value="manipulado">Manipulado</option>
        </select>
      </div>
      <!-- Fórmula agora é escolhida na etapa anterior -->
      <div class="form-group">
        <label>Nome do Produto</label>
        <input type="text" formControlName="name" required>
      </div>
      <div class="form-group full-width">
        <label>Descrição</label>
        <textarea formControlName="description" required rows="4"></textarea>
      </div>
    </div>
  </section>

  <!-- STEP 3: Preço/Estoque e Campanha -->
  <section *ngIf="step()===3" class="step step-preco">
    <div class="form-grid">
      <div class="form-group">
        <label>Preço</label>
        <input type="number" formControlName="price" required>
      </div>
      <div class="form-group full-width">
        <label>Campanha/Promoção</label>
        <ng-container *ngIf="promocaoSelecionada; else noPromo">
          <div class="promo-card">
            <div class="promo-header">
              <span class="badge" [class.active]="promocaoSelecionada.ui?.status==='active'" [class.upcoming]="promocaoSelecionada.ui?.status==='upcoming'" [class.expired]="promocaoSelecionada.ui?.status==='expired'" [class.inactive]="promocaoSelecionada.ui?.status==='inactive'">{{ promocaoSelecionada.ui?.status || '—' }}</span>
              <strong>{{ promocaoSelecionada.nome }}</strong>
              <span class="valor">{{ promocaoSelecionada.ui?.valor_label }}</span>
            </div>
            <div class="promo-meta">
              <div *ngIf="promocaoSelecionada.ui?.start?.human">Início: {{ promocaoSelecionada.ui?.start?.human }}</div>
              <div>Fim: {{ promocaoSelecionada.ui?.end?.human || 'sem validade' }}</div>
            </div>
            <div class="promo-actions">
              <button type="button" (click)="openPromoModal()">Trocar campanha</button>
              <button type="button" class="link" (click)="promocaoSelecionada=null">Remover</button>
            </div>
          </div>
        </ng-container>
        <ng-template #noPromo>
          <div class="empty">Nenhuma campanha aplicada.
            <button type="button" (click)="openPromoModal()">+ Aplicar campanha</button>
          </div>
        </ng-template>
      </div>
      <div class="form-group">
        <label>Estoque</label>
        <input type="number" formControlName="stock">
      </div>
      <div class="form-group">
        <label>Peso/Volume/Unidade</label>
        <div style="display:flex; gap:0.5rem;">
          <input type="number" formControlName="weightValue" placeholder="Valor">
          <select formControlName="weightUnit">
            <option value="mg">mg</option>
            <option value="g">g</option>
            <option value="kg">kg</option>
            <option value="ml">ml</option>
            <option value="un">un</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <!-- STEP 4: Categoria/Tags -->
  <section *ngIf="step()===4" class="step step-categorias">
    <div class="form-grid">
      <div class="form-group">
        <label>Categoria</label>
        <select formControlName="categoryId" required>
          <option [ngValue]="null">Selecione</option>
          <option *ngFor="let c of categoriasList" [ngValue]="c.id">{{ c.name }}</option>
        </select>
        <button type="button" (click)="showCategoryModal=true">+ Nova Categoria</button>
      </div>
      <div class="form-group full-width">
        <label>Tags</label>
        <div class="tags" style="display:flex; gap:0.5rem; flex-wrap:wrap;">
          <button type="button" *ngFor="let t of tagsList"
                  [class.selected]="hasTag(t.name)"
                  (click)="toggleTagVal(t.name)">{{t.name}}</button>
          <button type="button" (click)="showTagModal=true">+ Adicionar</button>
        </div>
      </div>
    </div>
  </section>

  <!-- STEP 5: Customizações -->
  <section *ngIf="step()===5" class="step step-custom">
    <div class="customizations">
      <h4>Dosagens</h4>
      <div class="dosagens" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
        <button type="button" *ngFor="let d of dosagesList"
                [class.selected]="hasDosage(d.name)"
                (click)="toggleDosageVal(d.name)">{{d.name}}</button>
        <button type="button" (click)="showDosageModal=true">+ Adicionar</button>
      </div>
    </div>
    <div class="customizations">
      <h4>Embalagens</h4>
      <div class="embalagens" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
        <button type="button" *ngFor="let p of embalagensList"
                [class.selected]="hasPackaging(p.name)"
                (click)="togglePackagingVal(p.name)">{{p.name}}</button>
        <button type="button" (click)="showPackagingModal=true">+ Adicionar</button>
      </div>
    </div>
  </section>

  <!-- STEP 6: Revisão e Envio -->
  <section *ngIf="step()===6" class="step step-revisao">
    <div class="review">
      <h4>Revisão</h4>
      <ul>
    <li><strong>Tipo:</strong> {{ form.value.formulaId ? 'manipulado' : 'pronto' }}</li>
    <li *ngIf="form.value.formulaId"><strong>Fórmula:</strong> {{ formulaNameById(form.value.formulaId) }}</li>
    <li *ngIf="estoqueSelecionado"><strong>Lote:</strong> {{ estoqueSelecionado.lote || '—' }} ({{ estoqueSelecionado.quantity }} {{ estoqueSelecionado.unit_code }})</li>
        <li><strong>Nome:</strong> {{ form.value.name }}</li>
        <li><strong>Descrição:</strong> {{ form.value.description }}</li>
        <li><strong>Preço:</strong> {{ form.value.price | currency:'BRL':'symbol-narrow' }}</li>
        <li><strong>Estoque:</strong> {{ form.value.stock ?? '—' }}</li>
  <li><strong>Categoria:</strong> {{ categoryNameById(form.value.categoryId) }}</li>
        <li><strong>Tags:</strong> {{ (form.value.tags || []).join(', ') || '—' }}</li>
        <li><strong>Dosagens:</strong> {{ (form.value.customizations?.dosage || []).join(', ') || '—' }}</li>
        <li><strong>Embalagens:</strong> {{ (form.value.customizations?.packaging || []).join(', ') || '—' }}</li>
        <li><strong>Campanha:</strong> {{ promocaoSelecionada ? (promocaoSelecionada.nome + ' • ' + (promocaoSelecionada.ui?.valor_label || '')) : '—' }}</li>
      </ul>
      <div class="gallery">
        <label>Imagens adicionais</label>
        <div class="thumbs">
          <div class="thumb" *ngFor="let img of imagesFA.controls; let i = index">
            <img [src]="img.value" alt="img">
            <div class="thumb-actions">
              <button type="button" (click)="moveImage(i,-1)">↑</button>
              <button type="button" (click)="moveImage(i,1)">↓</button>
              <button type="button" (click)="removeImageAt(i)">✕</button>
            </div>
            <div class="pos">{{ i }}</div>
          </div>
        </div>
        <input type="file" multiple (change)="onImagesSelected($event)">
      </div>
    </div>
  </section>

  <!-- Sticky footer actions -->
  <div class="footer-actions">
    <button type="button" class="btn-reset" (click)="prevStep()" [disabled]="step()===0">Voltar</button>
    <div class="spacer"></div>
  <button type="button" class="btn-next" *ngIf="step()<steps.length-1" (click)="nextStep()">{{ nextLabel() }}</button>
    <button type="button" class="btn-submit" *ngIf="step()===steps.length-1" (click)="submit()">{{ form.value.id ? 'Atualizar Produto' : 'Cadastrar Produto' }}</button>
  </div>
</div>

  <!-- Modais Taxonomias -->
  <div class="modal" *ngIf="showCategoryModal">
    <div class="modal-content">
      <h4>Selecionar ou Adicionar Categoria</h4>
      <div class="existing-items" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
        <span *ngFor="let c of categoriasList" class="badge" [class.selected]="form.value.categoryId === c.id" (click)="form.patchValue({ categoryId: c.id })">
          {{ c.name }}
          <span class="badge-remove" (click)="deleteTaxonomia('categorias', c)">-</span>
        </span>
      </div>
      <hr>
      <input #catInput type="text" placeholder="Ex: Vitaminas">
      <button (click)="createTaxonomia('categorias', catInput.value); catInput.value=''">Adicionar</button>
      <button (click)="showCategoryModal=false">Fechar</button>
    </div>
  </div>

  <div class="modal" *ngIf="showDosageModal">
    <div class="modal-content">
      <h4>Adicionar Dosagem</h4>
      <div class="existing-items" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
  <span *ngFor="let d of dosagesList" class="badge" [class.selected]="hasDosage(d.name)" (click)="toggleDosageVal(d.name)">
         {{ d.name }}
          <span class="badge-remove" (click)="deleteTaxonomia('dosages', d)">-</span>
        </span>
      </div>
      <hr>
      <input #dosInput type="text" placeholder="Ex: 25mg">
      <button (click)="addDosage(dosInput.value); dosInput.value=''">Adicionar</button>
      <button (click)="showDosageModal=false">Cancelar</button>
    </div>
  </div>

  <div class="modal" *ngIf="showPackagingModal">
    <div class="modal-content">
      <h4>Selecionar ou Adicionar Embalagem</h4>
      <div class="existing-items" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
  <span *ngFor="let p of embalagensList" class="badge" [class.selected]="hasPackaging(p.name)" (click)="togglePackagingVal(p.name)">
         {{ p.name }}
          <span class="badge-remove" (click)="deleteTaxonomia('embalagens', p)">-</span>
        </span>
      </div>
      <hr>
      <input #packInput type="text" placeholder="Ex: Caixa grande">
      <button (click)="addPackaging(packInput.value); packInput.value=''">Adicionar</button>
      <button (click)="showPackagingModal=false">Fechar</button>
    </div>
  </div>

  <div class="modal" *ngIf="showTagModal">
    <div class="modal-content">
      <h4>Selecionar ou Adicionar Tag</h4>
      <div class="existing-items" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
  <span *ngFor="let t of tagsList" class="badge" [class.selected]="hasTag(t.name)" (click)="toggleTagVal(t.name)">
         {{ t.name }}
          <span class="badge-remove" (click)="deleteTaxonomia('tags', t)">-</span>
        </span>
      </div>
      <hr>
      <input #tagInput type="text" placeholder="Ex: vitamina">
      <button (click)="addTag(tagInput.value); tagInput.value=''">Adicionar</button>
      <button (click)="showTagModal=false">Fechar</button>
    </div>
  </div>

  <div class="modal" *ngIf="success()">
    <div class="modal-content">
      <h4>{{ success() }}</h4>
      <button (click)="success.set(null); router.navigate(['/restrito/admin'])">OK</button>
    </div>
  </div>

  <!-- Modal Selecionar Promoção -->
  <div class="modal" *ngIf="showPromoModal">
    <div class="modal-content">
      <h4>Selecionar Campanha</h4>
      <div class="promo-list" *ngIf="promocoes?.length; else promoEmpty">
        <div class="promo-item" *ngFor="let pr of promocoes">
          <div class="row" (click)="promocaoSelecionada=pr; showPromoModal=false">
            <span class="badge" [class.active]="pr.ui?.status==='active'" [class.upcoming]="pr.ui?.status==='upcoming'" [class.expired]="pr.ui?.status==='expired'" [class.inactive]="pr.ui?.status==='inactive'">{{ pr.ui?.status || '—' }}</span>
            <strong class="name">{{ pr.nome }}</strong>
            <span class="valor">{{ pr.ui?.valor_label }}</span>
          </div>
          <div class="row small">
            <span *ngIf="pr.ui?.start?.human">Início: {{ pr.ui?.start?.human }}</span>
            <span>Fim: {{ pr.ui?.end?.human || 'sem validade' }}</span>
          </div>
          <div class="row actions">
            <button type="button" (click)="$event.stopPropagation(); openPromoDetail(pr.id!)">Editar promoção</button>
          </div>
        </div>
      </div>
      <ng-template #promoEmpty>
        <div class="empty">Nenhuma promoção encontrada. <button type="button" (click)="showPromoModal=false">Fechar</button></div>
      </ng-template>
      <div class="actions">
        <button type="button" (click)="showPromoModal=false">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal Detalhe da Promoção -->
  <div class="modal" *ngIf="showPromoDetail">
    <div class="modal-content promo-detail">
      <h4>{{ promoDetalhe?.nome }}</h4>
      <div class="detail-header">
        <span class="badge" [class.active]="promoDetalhe?.ui?.status==='active'" [class.upcoming]="promoDetalhe?.ui?.status==='upcoming'" [class.expired]="promoDetalhe?.ui?.status==='expired'" [class.inactive]="promoDetalhe?.ui?.status==='inactive'">{{ promoDetalhe?.ui?.status || '—' }}</span>
        <span class="valor">{{ promoDetalhe?.ui?.valor_label }}</span>
      </div>
      <p class="descricao" *ngIf="promoDetalhe?.descricao">{{ promoDetalhe?.descricao }}</p>
      <div class="grid">
        <div>
          <strong>Tipo:</strong> {{ promoDetalhe?.tipo }} ({{ promoDetalhe?.ui?.tipo_simbolo }})
        </div>
        <div>
          <strong>Início:</strong> {{ promoDetalhe?.ui?.start?.human || '—' }}
        </div>
        <div>
          <strong>Fim:</strong> {{ promoDetalhe?.ui?.end?.human || 'sem validade' }}
        </div>
        <div>
          <strong>Ativa agora?</strong> {{ promoDetalhe?.ui?.active_now ? 'Sim' : 'Não' }}
        </div>
      </div>
      <div class="produtos" *ngIf="promoDetalhe?.produtos?.length">
        <h5>Produtos vinculados</h5>
        <ul>
          <li *ngFor="let p of promoDetalhe!.produtos">#{{ p.id }} • {{ p.nome || p.name }} — {{ (p.preco || p.price) || '' }}</li>
        </ul>
      </div>
      <div class="actions">
        <button type="button" (click)="promocaoSelecionada=promoDetalhe!; showPromoDetail=false">Aplicar esta campanha</button>
        <button type="button" (click)="showPromoDetail=false">Fechar</button>
      </div>
    </div>
  </div>

