<div class="produto-container">
  <h2>{{ produto.id ? 'Editar Produto' : 'Cadastrar Produto' }}</h2>

  <!-- Upload de Imagem -->
  <div class="image-upload">
    <label for="imgUpload">
      <div class="img-preview" *ngIf="produto.image; else placeholder">
        <img [src]="produto.image" alt="Imagem do produto">
      </div>
      <ng-template #placeholder>
        <div class="img-placeholder">Clique para adicionar imagem</div>
      </ng-template>
    </label>
    <input type="file" id="imgUpload" (change)="onImageSelected($event)">
  </div>

  <form (ngSubmit)="submit()">
    <div class="form-grid">
      <!-- Nome -->
      <div class="form-group">
        <label>Nome do Produto</label>
        <input type="text" [(ngModel)]="produto.name" name="name" required>
      </div>

      <!-- Categoria -->
    <div class="form-group">
      <label>Categoria</label>
      <select [(ngModel)]="produto.category" name="category" required>
        <option *ngFor="let c of categoriasList" [value]="c.name">{{ c.name }}</option>
      </select>
      <button type="button" (click)="showCategoryModal=true">+ Nova Categoria</button>
    </div>

      <!-- Preço -->
      <div class="form-group">
        <label>Preço</label>
        <input type="number" [(ngModel)]="produto.price" name="price" required>
      </div>

      <!-- Estoque -->
      <div class="form-group">
        <label>Estoque</label>
        <input type="number" [(ngModel)]="produto.stock" name="stock">
      </div>

      <!-- Descrição -->
      <div class="form-group full-width">
        <label>Descrição</label>
        <textarea [(ngModel)]="produto.description" name="description" required></textarea>
      </div>

      <!-- Desconto -->
      <div class="form-group">
        <label>Desconto (%)</label>
        <input type="number" [(ngModel)]="produto.discount" name="discount">
      </div>

      <!-- Avaliação -->
<!-- Avaliação -->
<div class="form-group">
  <label>Avaliação</label>
  <input 
    type="number" 
    [(ngModel)]="produto.rating" 
    (blur)="fixRating($event)" 
    name="rating" 
    step="0.1" 
    max="5" 
    min="0">
</div>


      <!-- Peso/Unidade -->
      <div class="form-group">
        <label>Peso/Volume/Unidade</label>
        <div style="display:flex; gap:0.5rem;">
          <input type="number" [(ngModel)]="produto.weightValue" name="weightValue" placeholder="Valor">
          <select [(ngModel)]="produto.weightUnit" name="weightUnit">
            <option value="mg">mg</option>
            <option value="g">g</option>
            <option value="kg">kg</option>
            <option value="ml">ml</option>
            <option value="un">un</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Dosagens -->
    <div class="customizations">
      <h4>Dosagens</h4>
      <div class="dosagens" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
        <button type="button" *ngFor="let d of produto.customizations.dosage"
                [class.selected]="produto.customizations.dosage.includes(d)"
                (click)="toggleDosage(d)">
          {{d}}
        </button>
        <button type="button" (click)="showDosageModal=true">+ Adicionar</button>
      </div>
    </div>

    <!-- Embalagens -->
    <div class="customizations">
      <h4>Embalagens</h4>
      <div class="embalagens" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
        <button type="button" *ngFor="let p of produto.customizations.packaging"
                [class.selected]="produto.customizations.packaging.includes(p)"
                (click)="togglePackaging(p)">
          {{p}}
          <span class="remove-item" (click)="removePackaging(p, $event)">✖</span>
        </button>
        <button type="button" (click)="showPackagingModal=true">+ Adicionar</button>
      </div>
    </div>

    <!-- Tags -->
    <div class="customizations">
      <h4>Tags</h4>
      <div class="tags" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
        <button type="button" *ngFor="let t of produto.tags"
                [class.selected]="produto.tags.includes(t)"
                (click)="toggleTag(t)">
          {{t}}
          <span class="remove-item" (click)="removeTag(t)">✖</span>
        </button>
        <button type="button" (click)="showTagModal=true">+ Adicionar</button>
      </div>
    </div>

    <!-- Ações -->
    <div class="form-actions">
      <button type="submit" class="btn-submit">{{ produto.id ? 'Atualizar Produto' : 'Cadastrar Produto' }}</button>
      <button type="button" class="btn-reset" (click)="resetForm()">Limpar</button>
    </div>
  </form>

  <!-- =================== MODAIS =================== -->

  <!-- Modal Categoria -->
  <div class="modal" *ngIf="showCategoryModal">
    <div class="modal-content">
      <h4>Selecionar ou Adicionar Categoria</h4>
      <div class="existing-items" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
      <span *ngFor="let c of categoriasList" 
            class="badge" 
            [class.selected]="produto.category === c.name"
            (click)="toggleCategory(c.name)">
        {{ c.name }}
        <span class="badge-remove" (click)="removeCategory(c.name, $event)">-</span>
      </span>
      </div>
      <hr>
      <input type="text" [(ngModel)]="newCategory" placeholder="Ex: Vitaminas">
      <button (click)="addNewCategory(newCategory)">Adicionar</button>
      <button (click)="showCategoryModal=false">Fechar</button>
    </div>
  </div>

  <!-- Modal Dosagem -->
  <!-- Modal Dosagem -->
  <div class="modal" *ngIf="showDosageModal">
    <div class="modal-content">
      <h4>Adicionar Dosagem</h4>
      <div class="existing-items" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
<span *ngFor="let d of dosagesList" class="badge"
      [class.selected]="produto.customizations.dosage.includes(d.name)"
      (click)="toggleDosage(d.name)">
  {{ d.name }}
  <span class="badge-remove" (click)="removeDosage(d.name, $event)">-</span>
</span>


      </div>
      <hr>
      <input type="text" [(ngModel)]="newDosage" placeholder="Ex: 25mg">
      <button (click)="addDosage(newDosage)">Adicionar</button>
      <button (click)="showDosageModal=false">Cancelar</button>
    </div>
  </div>


  <!-- Modal Embalagem -->
  <div class="modal" *ngIf="showPackagingModal">
    <div class="modal-content">
      <h4>Selecionar ou Adicionar Embalagem</h4>
      <div class="existing-items" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
        <span *ngFor="let p of embalagensList" class="badge"
              [class.selected]="produto.customizations.packaging.includes(p.name)"
              (click)="togglePackaging(p.name)">
          {{ p.name }}
          <span class="badge-remove" (click)="removePackaging(p.name, $event)">-</span>
        </span>
      </div>
      <hr>
      <input type="text" [(ngModel)]="newPackaging" placeholder="Ex: Caixa grande">
      <button (click)="addNewPackaging(newPackaging)">Adicionar</button>
      <button (click)="showPackagingModal=false">Fechar</button>
    </div>
  </div>

  <!-- Modal Tags -->
  <div class="modal" *ngIf="showTagModal">
    <div class="modal-content">
      <h4>Selecionar ou Adicionar Tag</h4>
      <div class="existing-items" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
        <span *ngFor="let t of tagsList" class="badge"
              [class.selected]="produto.tags.includes(t.name)"
              (click)="toggleTag(t.name)">
          {{ t.name }}
          <span class="badge-remove" (click)="removeTag(t.name)">-</span>
        </span>
      </div>
      <hr>
      <input type="text" [(ngModel)]="newTag" placeholder="Ex: vitamina">
      <button (click)="addNewTag(newTag)">Adicionar</button>
      <button (click)="showTagModal=false">Fechar</button>
    </div>
  </div>

  <!-- Modal Success -->
  <div class="modal" *ngIf="showSuccessModal">
    <div class="modal-content">
      <h4>Produto {{ produto.id ? 'atualizado' : 'cadastrado' }} com sucesso!</h4>
      <button (click)="showSuccessModal=false; router.navigate(['/restrito/admin'])">OK</button>
    </div>
  </div>
</div>
