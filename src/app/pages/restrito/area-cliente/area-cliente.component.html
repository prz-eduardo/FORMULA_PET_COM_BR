<app-navmenu *ngIf="!modal"></app-navmenu>

<div class="area-cliente-wrapper" *ngIf="ready; else carregandoEstado">
  <h1 class="titulo">{{ titulo }}</h1>

  <!-- Login / Criar Conta -->
  <div *ngIf="!hasAuth" class="card login-card">
    <h2>Bem-vindo(a)!</h2>
    <p>Faça login ou crie sua conta para acessar os recursos.</p>
    <div class="acoes">
      <button class="btn" (click)="abrirModalLogin()">Login</button>
      <button class="btn btn-sec" (click)="abrirModalCadastro()">Criar Conta</button>
    </div>
  </div>

  <!-- Painel Cliente -->
  <div *ngIf="hasAuth" class="cliente-panel">
    <div class="cliente-info">
      <img *ngIf="clienteData?.photoURL" [src]="clienteData.photoURL" class="cliente-photo" />
      <span class="cliente-nome">{{ clienteData?.nome }}</span>
    </div>
    <div class="cliente-actions" (click)="$event.stopPropagation()">
      <button #gearBtn class="btn-gear" (click)="toggleMenu($event)" aria-haspopup="true" [attr.aria-expanded]="menuAberto ? 'true' : 'false'" aria-label="Abrir menu do usuário">⚙️</button>
      <div class="popover cliente-popover" *ngIf="menuAberto" role="menu" [ngStyle]="{ top: popoverTop + 'px', left: popoverLeft + 'px' }">
        <button class="popover-item profile" role="menuitem" (click)="open('perfil'); fecharMenu()">Perfil</button>
        <button class="popover-item danger" role="menuitem" (click)="logout(); fecharMenu()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Navegação interna quando em modal: barra de voltar -->
  <div *ngIf="modal && internalView" class="internal-back">
    <button class="btn btn-sec" (click)="goBack()"></button>
  </div>

  <!-- Widgets do Cliente -->
  <div class="menu-wrapper" *ngIf="hasAuth && (!modal || !internalView)">
    <div class="menu-cards-wrapper">
      <div class="menu-card" (click)="open('meus-pedidos')">
        <div class="card-icon">🛒</div>
        <div class="card-title">Meus Pedidos</div>
      </div>
      <div class="menu-card" (click)="open('consultar-pedidos')">
        <div class="card-icon">🩺</div>
        <div class="card-title">Histórico de receitas</div>
      </div>
      <div class="menu-card" (click)="open('meus-pets')">
        <div class="card-icon">🐶🐱</div>
        <div class="card-title">Meus Pets</div>
      </div>
      <div class="menu-card" (click)="open('novo-pet')">
        <div class="card-icon">➕</div>
        <div class="card-title">Cadastrar Pet</div>
      </div>      
    </div>

    <!-- overlay se algum widget estiver bloqueado -->
    <div *ngIf="!clienteData?.ativo" class="overlay-vidro-real"></div>
  </div>

  <!-- Pets removidos desta visão; aparecerão somente ao abrir "Meus Pets" -->

  <!-- Modais -->
  <ng-container *ngIf="modalLoginAberto">
    <div class="modal-overlay" (click)="fecharModalLogin()"></div>
    <div class="modal-content">
      <div (click)="$event.stopPropagation()">
        <app-login-cliente (close)="fecharModalLogin()" (loggedIn)="onLogin()"></app-login-cliente>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="modalCadastroAberto">
    <div class="modal-overlay" (click)="fecharModalCadastro()"></div>
    <div class="modal-content">
      <div (click)="$event.stopPropagation()">
  <app-crie-sua-conta-cliente (close)="fecharModalCadastro()" (loggedIn)="onLogin()"></app-crie-sua-conta-cliente>
      </div>
    </div>
  </ng-container>
  
  <!-- Host interno para subviews quando em modal -->
  <ng-template #internalHost></ng-template>
  <!-- Host sobreposto para modais internos (ex: consultar pedidos) -->
  <ng-template #overlayHost></ng-template>
</div>

<ng-template #carregandoEstado>
  <div class="area-cliente-wrapper">
    <h1 class="titulo">Área do Cliente 🐾</h1>
    <div class="card login-card">Inicializando...</div>
  </div>
</ng-template>
