<div class="carrinho-wrap">
  <app-navmenu></app-navmenu>
  <h1 class="titulo">Seu Carrinho</h1>

  <div class="layout" *ngIf="(store.cart$ | async)?.length; else vazio">
    <div class="card itens">
      <div class="item" *ngFor="let it of (store.cart$ | async)">
      <img [src]="it.product.image" alt="{{ it.product.name }}" />
      <div class="info">
        <div class="nome">{{ it.product.name }}</div>
        <div class="preco">{{ store.getPriceWithDiscount(it.product) | currency:'BRL' }}</div>
        <div class="qtd">
          <button (click)="dec(it.product.id)">-</button>
          <span>{{ it.quantity }}</span>
          <button (click)="inc(it.product.id)">+</button>
        </div>
        <!-- Prescription requirement UI -->
        <div class="prescription" *ngIf="it.product.requiresPrescription">
          <div class="warn">Este produto exige receita.</div>
          <app-prescription-picker
            [prescriptions]="receitasDisponiveis"
            [selectedId]="it.prescriptionId"
            [loading]="carregandoReceitas"
            (select)="onSelectPrescription(it.product.id, $event)"
            (upload)="onUploadPrescriptionFileDirect(it.product.id, $event)"
          ></app-prescription-picker>
          <div class="file" *ngIf="it.prescriptionFileName">Arquivo: {{ it.prescriptionFileName }}</div>
        </div>
      </div>
      <button class="remove" (click)="onRequestRemove(it.product.id)" aria-label="Remover item" title="Remover">&times;</button>
      </div>
    </div>

    <div class="aside">
      <div class="card frete">
        <h3>Calcular frete</h3>
        <div class="linha">
          <input type="text" class="input" placeholder="CEP" aria-label="CEP" />
          <button class="btn">Calcular</button>
        </div>
        <p class="muted">Entrega: valores e prazos serÃ£o exibidos aqui.</p>
      </div>
      <div class="card resumo">
        <h3>Resumo</h3>
        <div class="totais">
          <div>Itens: {{ total().count }}</div>
          <div>Subtotal: {{ total().subtotal | currency:'BRL' }}</div>
          <div class="grand">Total: {{ total().total | currency:'BRL' }}</div>
        </div>
        <div class="acoes">
          <button class="btn" (click)="clear()">Limpar carrinho</button>
          <button class="btn primary" [disabled]="!store.isCheckoutAllowed()" title="{{ store.isCheckoutAllowed() ? '' : 'Finalize as receitas pendentes' }}">Finalizar compra</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Destaques quando hÃ¡ itens no carrinho -->
  <section class="cart-highlights" *ngIf="(store.cart$ | async)?.length && !loadingHighlights && highlights?.length">
    <div class="card">
      <div class="ch-header">
        <h3>Continue descobrindo</h3>
        <p>Selecionamos alguns itens que combinam com a sua compra. Que tal dar uma olhada?</p>
      </div>
      <div class="ch-grid">
        <div class="ch-item" *ngFor="let p of highlights | slice:0:6">
          <div class="ch-img-box">
            <img [src]="p.image" [alt]="p.name" />
          </div>
          <div class="ch-name">{{ p.name }}</div>
          <div class="ch-bottom">
            <div class="ch-price">{{ store.getPriceWithDiscount(p) | currency:'BRL' }}</div>
            <button class="btn add" (click)="store.addToCart(p, 1)">Adicionar</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Sticky checkout bar (mobile only) -->
  <div class="checkout-bar mobile-only" *ngIf="(store.cart$ | async)?.length">
    <div class="bar-content">
      <div class="bar-total">
        <strong>Total</strong>
        <span>{{ total().total | currency:'BRL' }}</span>
        <small class="count">{{ total().count }} itens</small>
      </div>
      <button class="btn primary" aria-label="Finalizar compra" [disabled]="!store.isCheckoutAllowed()" title="{{ store.isCheckoutAllowed() ? '' : 'Finalize as receitas pendentes' }}">Finalizar</button>
    </div>
  </div>

  <ng-template #vazio>
    <div class="card vazio">
      <div class="empty-text">Seu carrinho ainda estÃ¡ vazio ðŸ˜º</div>
      <p class="empty-sub">Enquanto isso, separamos alguns favoritos da nossa loja para vocÃª comeÃ§ar:</p>
      <div class="highlight-box" *ngIf="!loadingHighlights && highlights?.length">
        <h3 class="h-title">SugestÃµes que seu pet vai amar</h3>
        <div class="h-grid">
          <div class="h-item" *ngFor="let p of highlights | slice:0:8">
            <div class="h-img-box">
              <img [src]="p.image" [alt]="p.name" />
              <div class="h-name">{{ p.name }}</div>
            </div>
            <div class="h-bottom">
              <div class="h-price">{{ store.getPriceWithDiscount(p) | currency:'BRL' }}</div>
              <button class="btn add" (click)="store.addToCart(p, 1)">Adicionar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- ConfirmaÃ§Ã£o de remoÃ§Ã£o -->
  <div class="overlay" *ngIf="showConfirmRemove" (click)="cancelRemove()"></div>
  <div class="confirm-modal" *ngIf="showConfirmRemove" role="dialog" aria-modal="true" aria-label="Remover item do carrinho" (click)="$event.stopPropagation()">
    <div class="sad-face" aria-hidden="true">ðŸ˜¿</div>
    <h3>Remover do carrinho?</h3>
    <p class="msg">{{ confirmTargetName || 'Este item' }} serÃ¡ removido do seu carrinho.</p>
    <div class="actions">
      <button class="btn light" (click)="cancelRemove()">Cancelar</button>
      <!-- BotÃ£o destrutivo com menor destaque -->
      <button class="btn subtle-danger" (click)="confirmRemoveNow()" title="Remover definitivamente">Remover mesmo</button>
    </div>
  </div>
</div>
