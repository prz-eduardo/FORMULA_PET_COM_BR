<div class="carrinho-wrap">
  <app-navmenu></app-navmenu>
  <h1 class="titulo">
    <span class="cart-ico" aria-hidden="true">üõí</span>
    Seu Carrinho
  </h1>

  <div class="layout" *ngIf="(store.cart$ | async)?.length; else vazio">
  <div class="card itens highlighted">
      <div class="item" *ngFor="let it of (store.cart$ | async)">
      <img [src]="it.product.image" alt="{{ it.product.name }}" />
      <div class="info">
        <div class="nome">{{ it.product.name }}</div>
        <div class="preco">{{ store.getPriceWithDiscount(it.product) | currency:'BRL' }}</div>
        <div class="qtd">
          <button (click)="dec(it.product.id)">-</button>
          <span>{{ it.quantity }}</span>
          <button (click)="inc(it.product.id)">+</button>
        </div>
        <!-- Prescription requirement UI -->
        <div class="prescription" *ngIf="it.product.requiresPrescription">
          <div class="warn">Este produto exige receita.</div>
          <app-prescription-picker
            [prescriptions]="receitasDisponiveis"
            [selectedId]="it.prescriptionId"
            [loading]="carregandoReceitas"
            (select)="onSelectPrescription(it.product.id, $event)"
            (upload)="onUploadPrescriptionFileDirect(it.product.id, $event)"
          ></app-prescription-picker>
          <div class="file" *ngIf="it.prescriptionFileName">Arquivo: {{ it.prescriptionFileName }}</div>
        </div>
      </div>
      <button class="remove" (click)="onRequestRemove(it.product.id)" aria-label="Remover item" title="Remover">&times;</button>
      </div>
    </div>

    <div class="aside">
      <!-- Modo de entrega / retirada -->
      <div class="card entrega">
        <h3>Entrega ou retirada</h3>
        <div class="radio-group">
          <label class="radio-pill">
            <input type="radio" name="entrega" value="retirada" [(ngModel)]="entregaModo" (change)="calcularFrete()" />
            <span class="dot"></span>
            <span class="lbl">Retirar na loja</span>
          </label>
          <label class="radio-pill">
            <input type="radio" name="entrega" value="entrega" [(ngModel)]="entregaModo" (change)="calcularFrete()" />
            <span class="dot"></span>
            <span class="lbl">Entrega no endere√ßo</span>
          </label>
        </div>

        <!-- Se retirada: mostra endere√ßo e hor√°rio da loja -->
        <div class="retirada-info" *ngIf="entregaModo==='retirada'">
          <div class="loja">{{ lojaInfo.nome }}</div>
          <div class="end">{{ lojaInfo.endereco }}</div>
          <div class="cep">CEP {{ lojaInfo.cep }}</div>
          <div class="horario">Hor√°rio: {{ lojaInfo.horario }}</div>
        </div>

        <!-- Se entrega: sele√ß√£o de endere√ßo -->
        <div class="entrega-info" *ngIf="entregaModo==='entrega'">
          <div class="addr-resumo" *ngIf="enderecoSelecionado; else noAddr">
            <div class="linha"><strong>{{ enderecoSelecionado?.logradouro }}, {{ enderecoSelecionado?.numero }}</strong></div>
            <div class="linha">{{ enderecoSelecionado?.bairro }} - {{ enderecoSelecionado?.cidade }}/{{ enderecoSelecionado?.estado }}</div>
            <div class="linha">CEP {{ enderecoSelecionado?.cep }}</div>
          </div>
          <ng-template #noAddr>
            <div class="muted">Nenhum endere√ßo selecionado.</div>
          </ng-template>
          <div class="acoes">
            <button class="btn light" (click)="abrirModalEnderecos()">Escolher endere√ßo</button>
          </div>
          <div class="frete-ret" *ngIf="freteValor>0 || fretePrazo">
            <div class="linha">Frete: <strong>{{ freteValor | currency:'BRL' }}</strong> <span class="prazo" *ngIf="fretePrazo">({{ fretePrazo }})</span></div>
          </div>
        </div>
      </div>
      <div class="card frete">
        <h3>Calcular frete</h3>
        <div class="linha">
          <input type="text" class="input" placeholder="CEP" aria-label="CEP" />
          <button class="btn">Calcular</button>
        </div>
        <p class="muted">Entrega: valores e prazos ser√£o exibidos aqui.</p>
      </div>
      <div class="card resumo">
        <h3>Resumo do pedido</h3>
        <div class="totais">
          <div>Itens: {{ total().count }}</div>
          <div>Subtotal: {{ total().subtotal | currency:'BRL' }}</div>
          <div *ngIf="entregaModo==='entrega'" class="frete">Frete: {{ freteValor | currency:'BRL' }}</div>
          <div class="grand">Total: {{ total().total | currency:'BRL' }}</div>
          <div class="grand" *ngIf="entregaModo==='entrega'">Total com frete: {{ totalComFrete | currency:'BRL' }}</div>
        </div>
        <div class="acoes">
          <button class="btn" (click)="clear()">Limpar carrinho</button>
          <button class="btn primary" [disabled]="!store.isCheckoutAllowed()" title="{{ store.isCheckoutAllowed() ? '' : 'Finalize as receitas pendentes' }}">Finalizar compra</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Destaques quando h√° itens no carrinho -->
  <section class="cart-highlights" *ngIf="(store.cart$ | async)?.length && !loadingHighlights && highlights?.length">
    <div class="card">
      <div class="ch-header">
        <h3>Continue descobrindo üêæ</h3>
        <p>Selecionamos itens que combinam com o seu pedido. Complete seu carrinho com essas sugest√µes favoritas.</p>
      </div>
      <div class="ch-grid">
        <div class="ch-item" *ngFor="let p of highlights | slice:0:6">
          <div class="ch-img-box">
            <img [src]="p.image" [alt]="p.name" />
            <div class="ch-badge" *ngIf="p.discount && p.discount > 0">-{{ p.discount | number:'1.0-0' }}%</div>
          </div>
          <div class="ch-name">{{ p.name }}</div>
          <div class="ch-rating" *ngIf="p.rating != null || p.ratingsCount">
            <span class="stars">
              <ng-container *ngFor="let s of [1,2,3,4,5]">
                <span class="star">{{ s <= (p.rating || 0) ? '‚òÖ' : '‚òÜ' }}</span>
              </ng-container>
            </span>
            <span class="r-total" *ngIf="p.ratingsCount">({{ p.ratingsCount }})</span>
          </div>
          <div class="ch-bottom">
            <div class="ch-price">{{ store.getPriceWithDiscount(p) | currency:'BRL' }}</div>
            <button class="btn add" (click)="store.addToCart(p, 1)" [attr.aria-label]="'Adicionar ' + p.name + ' ao carrinho'">Adicionar</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Sticky checkout bar (mobile only) -->
  <div class="checkout-bar mobile-only" *ngIf="(store.cart$ | async)?.length">
    <div class="bar-content">
      <div class="bar-total">
        <strong>Total</strong>
        <span>{{ total().total | currency:'BRL' }}</span>
        <small class="count">{{ total().count }} itens</small>
      </div>
      <button class="btn primary" aria-label="Finalizar compra" [disabled]="!store.isCheckoutAllowed()" title="{{ store.isCheckoutAllowed() ? '' : 'Finalize as receitas pendentes' }}">Finalizar</button>
    </div>
  </div>

  <ng-template #vazio>
    <div class="card vazio">
      <div class="empty-text">Seu carrinho ainda est√° vazio üò∫</div>
      <p class="empty-sub">Enquanto isso, separamos alguns favoritos da nossa loja para voc√™ come√ßar:</p>
      <div class="highlight-box" *ngIf="!loadingHighlights && highlights?.length">
        <h3 class="h-title">Sugest√µes que seu pet vai amar</h3>
        <div class="h-grid">
          <div class="h-item" *ngFor="let p of highlights | slice:0:8">
            <div class="h-img-box">
              <img [src]="p.image" [alt]="p.name" />
              <div class="h-name">{{ p.name }}</div>
            </div>
            <div class="h-bottom">
              <div class="h-price">{{ store.getPriceWithDiscount(p) | currency:'BRL' }}</div>
              <button class="btn add" (click)="store.addToCart(p, 1)">Adicionar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Confirma√ß√£o de remo√ß√£o -->
  <div class="overlay" *ngIf="showConfirmRemove" (click)="cancelRemove()"></div>
  <div class="confirm-modal" *ngIf="showConfirmRemove" role="dialog" aria-modal="true" aria-label="Remover item do carrinho" (click)="$event.stopPropagation()">
    <div class="sad-face" aria-hidden="true">üòø</div>
    <h3>Remover do carrinho?</h3>
    <p class="msg">{{ confirmTargetName || 'Este item' }} ser√° removido do seu carrinho.</p>
    <div class="actions">
      <!-- Bot√£o destrutivo com menor destaque -->
      <button class="btn subtle-danger" (click)="confirmRemoveNow()" title="Remover definitivamente">Remover mesmo</button>
      <!-- Cancelar com maior destaque para incentivar o retorno -->
      <button class="btn primary" (click)="cancelRemove()">Cancelar</button>
    </div>
  </div>

  <!-- Modal de endere√ßos -->
  <div class="overlay" *ngIf="mostrandoEnderecos" (click)="fecharModalEnderecos()"></div>
  <div class="addr-modal" *ngIf="mostrandoEnderecos" (click)="$event.stopPropagation()" role="dialog" aria-modal="true" aria-label="Selecionar endere√ßo">
    <h3>Endere√ßos de entrega</h3>
    <div class="lista" *ngIf="enderecos?.length; else cadNovo">
      <label class="addr-item" *ngFor="let e of enderecos" (click)="selecionarEndereco(e)">
        <span class="dot"></span>
        <div class="dados">
          <div class="linha"><strong>{{ e.logradouro }}, {{ e.numero }}</strong> <span *ngIf="e.complemento"> - {{ e.complemento }}</span></div>
          <div class="linha">{{ e.bairro }} - {{ e.cidade }}/{{ e.estado }}</div>
          <div class="linha">CEP {{ e.cep }}</div>
        </div>
      </label>
      <div class="acoes">
        <button class="btn light" (click)="fecharModalEnderecos()">Fechar</button>
      </div>
    </div>
    <ng-template #cadNovo>
      <form class="cad-form" #f="ngForm" (ngSubmit)="cadastrarEndereco(f.value)" autocomplete="on">
        <div class="grid">
          <input name="cep" ngModel required placeholder="CEP" />
          <input name="logradouro" ngModel required placeholder="Logradouro" />
          <input name="numero" ngModel required placeholder="N√∫mero" />
          <input name="complemento" ngModel placeholder="Complemento" />
          <input name="bairro" ngModel required placeholder="Bairro" />
          <input name="cidade" ngModel required placeholder="Cidade" />
          <input name="estado" ngModel required placeholder="UF" />
        </div>
        <div class="acoes">
          <button type="button" class="btn light" (click)="fecharModalEnderecos()">Cancelar</button>
          <button type="submit" class="btn">Salvar endere√ßo</button>
        </div>
      </form>
    </ng-template>
  </div>
</div>
