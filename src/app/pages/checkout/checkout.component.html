<div class="checkout-wrap">
  <app-navmenu></app-navmenu>
  <header class="header">
    <div class="left">
      <div class="title-row">
        <h1>Finalizar compra</h1>
        <span class="order-pill" *ngIf="pedidoCodigo">#{{ pedidoCodigo }}</span>
      </div>
      <p class="sub">Revise seus dados e escolha a forma de pagamento. Assim que o pagamento for aprovado, come√ßaremos a preparar seu pedido.</p>
    </div>
      <div class="right">
        <div *ngIf="pagamentoStatus==='pago'; else aguardandoBadge" class="status ok badge">Pago</div>
        <ng-template #aguardandoBadge>
          <div class="status wait badge">Aguardando pagamento</div>
        </ng-template>
      </div>
  </header>

  <div class="grid">
    <section class="col main">
      <!-- Itens do pedido -->
      <div class="card">
        <h3>Itens do seu pedido</h3>
        <div class="items" *ngIf="pedido?.itens?.length; else noItems">
          <div class="row" *ngFor="let i of pedido.itens">
            <div class="n">{{ i.nome }}</div>
            <div class="qtd">√ó {{ i.quantidade }}</div>
            <div class="val">{{ i.subtotal | currency:'BRL' }}</div>
          </div>
        </div>
        <ng-template #noItems>
          <div class="muted">N√£o foi poss√≠vel carregar os itens do pedido. Voc√™ ainda pode concluir o pagamento abaixo.</div>
        </ng-template>
      </div>

      <!-- Entrega/Retirada -->
      <div class="card">
        <h3>Entrega</h3>
        <div *ngIf="entregaModo==='retirada'" class="entrega">
          <div class="emoji">üè™</div>
          <div class="txt">
            <div class="tt">Retirada na loja</div>
            <div>{{ lojaInfo.nome }} ‚Äî {{ lojaInfo.endereco }} ‚Äî CEP {{ lojaInfo.cep }}</div>
            <div>Hor√°rio: {{ lojaInfo.horario }}</div>
          </div>
        </div>
        <div *ngIf="entregaModo==='entrega'" class="entrega">
          <div class="emoji">üì¶</div>
          <div class="txt">
            <div class="tt">Entrega no endere√ßo</div>
            <div *ngIf="enderecoSelecionado; else noEnd">
              {{ enderecoSelecionado.logradouro }}, {{ enderecoSelecionado.numero }}
              <span *ngIf="enderecoSelecionado.complemento"> - {{ enderecoSelecionado.complemento }}</span>
              ‚Äî {{ enderecoSelecionado.bairro }} ‚Äî {{ enderecoSelecionado.cidade }}/{{ enderecoSelecionado.estado }} ‚Äî CEP {{ enderecoSelecionado.cep }}
            </div>
            <ng-template #noEnd><em>Endere√ßo n√£o informado ‚Äî este pedido ser√° separado para retirada na loja.</em></ng-template>
            <div class="frete" *ngIf="freteSelecionado">
              <span class="badge">{{ freteSelecionado.nome || freteSelecionado.servico }}</span>
              <span class="sep">‚Ä¢</span>
              <span>{{ freteSelecionado.valor || 0 | currency:'BRL' }}</span>
              <span *ngIf="freteSelecionado.prazo_dias != null" class="sep">‚Ä¢</span>
              <span *ngIf="freteSelecionado.prazo_dias != null">{{ freteSelecionado.prazo_dias }} dia(s)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagamento -->
      <div class="card">
        <h3>Pagamento</h3>
        <div class="cupom">
          <label for="cupom">Possui cupom?</label>
          <div class="row">
            <input id="cupom" [(ngModel)]="cupomCodigo" placeholder="DIGITE SEU CUPOM" />
            <button class="btn" (click)="aplicarCupom()" [disabled]="carregando || !cupomCodigo">Aplicar</button>
          </div>
          <div class="cupom-feedback" *ngIf="cupomErro">
            <div class="msg erro">{{ cupomErro }}</div>
          </div>
          <div class="cupom-feedback" *ngIf="cupomAplicado as cupomApl">
            <div class="msg ok">
              <strong>üéâ Cupom {{ cupomApl.codigo }} aplicado!</strong>
              <span *ngIf="((cupomApl.valor || 0) || (resumo.cupom || 0)) > 0" class="desc">Desconto: -{{ (cupomApl.valor || resumo.cupom || 0) | currency:'BRL' }}</span>
            </div>
          </div>
        </div>
        <div class="pay-head">
          <div class="pay-title">Como deseja pagar?</div>
        </div>
        <div class="pay-methods">
          <label class="method-card" *ngFor="let p of pagamentoOpcoes" [class.selected]="pagamentoMetodo===p.metodo">
            <input type="radio" name="pg" [value]="p.metodo" [(ngModel)]="pagamentoMetodo" />
            <span class="icon" [ngClass]="p.metodo" aria-hidden="true">
                <img *ngIf="p.metodo==='pix'" src="imagens/pix-icon.png" alt="PIX" />
              <svg *ngIf="p.metodo==='cartao'" viewBox="0 0 24 24" width="26" height="26"><rect x="3" y="5" width="18" height="14" rx="2" fill="#2563eb"/><rect x="3" y="8" width="18" height="3" fill="#1e40af"/></svg>
            </span>
            <span class="label">{{ p.label || (p.metodo | titlecase) }}</span>
            <span class="desc" *ngIf="p.metodo==='pix'">Confirma rapidinho</span>
            <span class="desc" *ngIf="p.metodo==='cartao'">Cart√£o de cr√©dito</span>
          </label>
        </div>
        <div class="pix-badge" *ngIf="temDescontoPix">
          <span class="ico">üíö</span>
          <strong>10% OFF no PIX</strong>
          <span class="muted">Desconto visual aplicado aqui, confirmado no pagamento</span>
        </div>
        <div class="help-wa">
          <span class="wa-ico" aria-hidden="true"></span>
          <span>Em caso de d√∫vidas, fale com a gente no WhatsApp: 
            <a class="wa-link" href="https://wa.me/554132051910" target="_blank" rel="noopener">(41) 3205-1910</a>
          </span>
        </div>
          <div class="method-cta">
            <button class="btn cta" [disabled]="carregando || !pedidoCodigo" (click)="pagar()">
              {{ pagamentoMetodo==='pix' ? 'Pagar com Pix' : (pagamentoMetodo==='cartao' ? 'Pagar com Cart√£o' : 'Continuar') }}
            </button>
          </div>
        <div class="hint" *ngIf="pagamentoMetodo==='pix'">Pix confirma rapidinho. Voc√™ ver√° um QR Code e o c√≥digo copia e cola. Fluxo de pagamento simulado.</div>
  <div class="hint" *ngIf="pagamentoMetodo==='cartao'">Pagamento no cart√£o √© simulado. Informe dados fict√≠cios para concluir.</div>
        <div class="alert-simulado">Ambiente de teste: pagamentos e comprovantes s√£o apenas simula√ß√µes.</div>
      </div>
    </section>

    <aside class="col side">
      <div class="card resumo" [class.anim-gain]="animacaoValor==='gain'" [class.anim-lose]="animacaoValor==='lose'">
        <h3>Resumo do pedido</h3>
        <div class="line"><span>Itens</span><strong>{{ resumo.item_count }}</strong></div>
        <div class="line"><span>Subtotal</span><strong>{{ resumo.subtotal | currency:'BRL' }}</strong></div>
        <div class="line" *ngIf="resumo.desconto>0"><span>Descontos</span><strong class="neg">-{{ resumo.desconto | currency:'BRL' }}</strong></div>
        <div class="line" *ngIf="resumo.cupom>0"><span>Cupom</span><strong class="neg">-{{ resumo.cupom | currency:'BRL' }}</strong></div>
        <div class="line"><span>Frete</span><strong>{{ resumo.frete | currency:'BRL' }}</strong></div>
        <div class="line" *ngIf="temDescontoPix"><span>PIX 10% OFF</span><strong class="neg">-{{ pixValorDesconto | currency:'BRL' }}</strong></div>
        <div class="total" [class.bump]="animacaoValor!==''"><span>Total a pagar</span><strong>{{ totalVisual | currency:'BRL' }}</strong></div>
      </div>
      <div class="card dicas">
        <h3>Informa√ß√µes importantes</h3>
        <ul>
          <li>Produtos manipulados s√£o preparados sob demanda. O prazo de entrega come√ßa ap√≥s a produ√ß√£o.</li>
          <li>Voc√™ receber√° atualiza√ß√µes por e-mail/WhatsApp quando seu pedido estiver pronto.</li>
          <li class="duvidas">D√∫vidas? <a class="wa-link" href="https://wa.me/554132051910" target="_blank" rel="noopener"><span class="wa-ico" aria-hidden="true"></span> (41) 3205-1910</a></li>
        </ul>
      </div>
    </aside>
  </div>

  <!-- Modal PIX (simulado) -->
  <div class="overlay" *ngIf="showPixModal" (click)="closePixModal()"></div>
  <div class="modal pix" *ngIf="showPixModal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true">
    <h3>Pagamento via PIX (simulado)</h3>
    <p>Escaneie o QR Code abaixo no aplicativo do seu banco ou use o bot√£o de copiar para pagar por Pix copia e cola.</p>
  <div class="qr"><img [src]="pixMock?.qrDataUrl" alt="QR Code PIX simulado"/></div>
  <div class="pix-powered"><img src="imagens/logo-pix.png" alt="Pix"/></div>
    <div class="copy">
      <input [value]="pixMock?.copiaCola" readonly />
      <button class="btn" (click)="copiar(pixMock?.copiaCola || '')">Copiar c√≥digo</button>
    </div>
    <div class="acoes">
      <button class="btn light" (click)="closePixModal()">Fechar</button>
      <button class="btn success" (click)="confirmarPixPago()">J√° paguei</button>
    </div>
    <div class="simulado">Transa√ß√£o simulada ‚Äî nenhum valor ser√° cobrado.</div>
  </div>

  <!-- Modal Cart√£o (simulado) -->
  <div class="overlay" *ngIf="showCardModal" (click)="closeCardModal()"></div>
  <div class="modal card" *ngIf="showCardModal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true">
    <h3>Cart√£o de cr√©dito (simulado)</h3>
    <div class="card-form">
      <label>Nome impresso
        <input [(ngModel)]="cardMock.nome" placeholder="FULANO DE TAL"/>
      </label>
      <label>N√∫mero do cart√£o
        <input [(ngModel)]="cardMock.numero" placeholder="4111 1111 1111 1111"/>
      </label>
      <div class="grid2">
        <label>Validade
          <input [(ngModel)]="cardMock.validade" placeholder="12/30"/>
        </label>
        <label>CVV
          <input [(ngModel)]="cardMock.cvv" placeholder="123"/>
        </label>
      </div>
    </div>
    <div class="acoes">
      <button class="btn light" (click)="closeCardModal()">Cancelar</button>
      <button class="btn success" (click)="confirmarCartaoPago()">Pagar {{ resumo.total | currency:'BRL' }}</button>
    </div>
    <div class="simulado">Pagamento simulado ‚Äî use dados fict√≠cios.</div>
  </div>
</div>

<!-- Mobile sticky pay bar -->
<div class="sticky-paybar" [class.bump]="animacaoValor!==''">
  <div class="sum">
    <div class="lbl">Total</div>
    <div class="amt">{{ totalVisual | currency:'BRL' }}</div>
  </div>
  <button class="btn cta" [disabled]="carregando || !pedidoCodigo" (click)="pagar()">
    {{ pagamentoMetodo==='pix' ? 'Pagar com Pix' : (pagamentoMetodo==='cartao' ? 'Pagar com Cart√£o' : 'Pagar') }}
  </button>
</div>
