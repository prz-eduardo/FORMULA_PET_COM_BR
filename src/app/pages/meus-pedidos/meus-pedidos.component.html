<app-navmenu *ngIf="!modal"></app-navmenu>

<div class="area-like-wrapper">
  <main class="container">
    <div class="top-actions" *ngIf="!modal">
      <button class="btn-back" (click)="voltar()">‚Üê Voltar</button>
    </div>
  <h1 class="titulo" *ngIf="!modal">Meus Pedidos</h1>
    <!-- filtros -->
    <div class="filters">
      <div class="row">
        <div class="field w-2">
          <label>Buscar</label>
          <input type="text" placeholder="id, cupom, observa√ß√£o" [(ngModel)]="buscaCodigo" (keyup.enter)="consultarPorCodigo()" />
        </div>
        <div class="field">
          <label>Status</label>
          <select [(ngModel)]="filtroStatus" aria-label="Status do pedido">
            <option value="">Todos</option>
            <option value="criado">Criado</option>
            <option value="pago">Pago</option>
            <option value="em_preparo">Em preparo</option>
            <option value="enviado">Enviado</option>
            <option value="concluido">Conclu√≠do</option>
            <option value="cancelado">Cancelado</option>
          </select>
        </div>
        <div class="field">
          <label>Pgto</label>
          <select [(ngModel)]="filtroPgStatus" aria-label="Status do pagamento">
            <option value="">Todos</option>
            <option value="aprovado">Aprovado</option>
            <option value="pendente">Pendente</option>
            <option value="recusado">Recusado</option>
            <option value="aguardando">Aguardando</option>
          </select>
        </div>
        <div class="field">
          <label>Forma</label>
          <select [(ngModel)]="filtroPgForma" aria-label="Forma de pagamento">
            <option value="">Todas</option>
            <option value="pix">PIX</option>
            <option value="cartao">Cart√£o</option>
            <option value="boleto">Boleto</option>
          </select>
        </div>
        <div class="field">
          <label>De</label>
          <input type="date" [(ngModel)]="filtroFrom" placeholder="AAAA-MM-DD" title="Data inicial" />
        </div>
        <div class="field">
          <label>At√©</label>
          <input type="date" [(ngModel)]="filtroTo" placeholder="AAAA-MM-DD" title="Data final" />
        </div>
        <div class="field align-end">
          <label class="muted">&nbsp;</label>
          <!-- <label class="toggle-details"><input type="checkbox" [(ngModel)]="includeDetails" (change)="page=1; load()" /> detalhes</label> -->
        </div>
        <div class="actions">
          <button class="btn" (click)="page=1; load()" [disabled]="carregando">Filtrar</button>
          <button class="btn btn-sec" (click)="filtroStatus='';filtroPgStatus='';filtroPgForma='';filtroFrom='';filtroTo='';buscaCodigo='';page=1;load()" [disabled]="carregando">Limpar</button>
        </div>
      </div>
    </div>

    <section class="order-list" *ngIf="!carregando && pedidos.length; else stateBlock">
      <article class="order-card" *ngFor="let p of pedidos" [attr.data-id]="p.id">
        <header class="order-head" (click)="toggleExpand(p.id)" [attr.aria-expanded]="expanded[p.id] ? 'true' : 'false'">
          <div class="left">
            <div class="codigo">#{{ p.id }}</div>
            <div class="badge" [class.cancelado]="isCancelado(p)" [class.concluido]="isConcluido(p)">{{ statusLabel(p.status) }}</div>
          </div>
          <div class="right">
            <div class="datas">
              <div><span class="label">Criado</span> <span class="value">{{ p.created_at | date:'short' }}</span></div>
              <div><span class="label">Atualizado</span> <span class="value">{{ p.updated_at | date:'short' }}</span></div>
            </div>
            <button class="btn" (click)="$event.stopPropagation(); toggleExpand(p.id)" [attr.aria-label]="expanded[p.id] ? 'Fechar detalhes' : 'Ver detalhes'">
              <ng-container *ngIf="!expanded[p.id]">Ver detalhes</ng-container>
              <ng-container *ngIf="expanded[p.id]">√ó</ng-container>
            </button>
          </div>
        </header>
        <div class="summary">
          <div class="line"><span class="label">Pagamento</span><span class="value">{{ p.pagamento_forma || '-' }} ‚Ä¢ {{ p.pagamento_status || '-' }}</span></div>
          <div class="totais">
            <span>Itens: R$ {{ p.totals?.items_total | number:'1.2-2' }}</span>
            <span>Frete: R$ {{ p.totals?.frete_total | number:'1.2-2' }}</span>
            <span *ngIf="p.totals?.discount_total && p.totals?.discount_total > 0">Desconto: -R$ {{ p.totals?.discount_total | number:'1.2-2' }}</span>
            <span class="grand">Total: R$ {{ p.totals?.grand_total | number:'1.2-2' }}</span>
          </div>
          <div class="cupom" *ngIf="p.cupom?.codigo">
            Cupom: <strong>{{ p.cupom.codigo }}</strong> (‚àíR$ {{ p.cupom.desconto_aplicado | number:'1.2-2' }})
          </div>
        </div>
        
        <!-- Novo indicador de status -->
        <div class="status-progress" *ngIf="!isConcluido(p) && !isCancelado(p)" aria-label="Status do pedido">
          <div class="segments">
            <div class="seg" *ngFor="let s of statusSteps(p); let i = index" [class.done]="s.done" [class.active]="s.active"></div>
          </div>
          <div class="labels">
            <div class="lab" *ngFor="let s of statusSteps(p)" [class.done]="s.done" [class.active]="s.active">{{ s.label }}</div>
          </div>
        </div>

        <!-- Corpo expandido com detalhes bonitos -->
        <section class="order-body" *ngIf="expanded[p.id]">
          <div class="grid">
            <div class="card compact entrega">
              <div class="card-head">
                <div class="tt">üì¶ Entrega</div>
              </div>
              <div class="kv"><span class="k">Tipo</span><span class="v">{{ p.raw_shipping?.frete?.nome || p.raw_shipping?.frete?.servico || '‚Äî' }}</span></div>
              <div class="kv"><span class="k">Prazo</span><span class="v">{{ p.raw_shipping?.frete?.prazo_dias ? (p.raw_shipping?.frete?.prazo_dias + ' dia(s)') : '‚Äî' }}</span></div>
              <div class="kv"><span class="k">Frete</span><span class="v">R$ {{ p.totals?.frete_total | number:'1.2-2' }}</span></div>
              <div class="addr" *ngIf="p.endereco_entrega">
                <div class="name" *ngIf="p.endereco_entrega.nome || p.endereco_entrega.destinatario">{{ p.endereco_entrega.nome || p.endereco_entrega.destinatario }}</div>
                <div class="line">{{ p.endereco_entrega.logradouro }}, {{ p.endereco_entrega.numero }}<span *ngIf="p.endereco_entrega.complemento"> - {{ p.endereco_entrega.complemento }}</span></div>
                <div class="line">{{ p.endereco_entrega.bairro }} - {{ p.endereco_entrega.cidade }}/{{ p.endereco_entrega.estado }}</div>
                <div class="line">CEP {{ p.endereco_entrega.cep }}</div>
              </div>
            </div>
            <div class="card compact">
              <div class="card-head">
                <div class="tt">Pagamento</div>
              </div>
              <div class="kv"><span class="k">Forma</span><span class="v">{{ p.pagamento_forma || '‚Äî' }}</span></div>
              <div class="kv"><span class="k">Status</span><span class="v">{{ p.pagamento_status || '‚Äî' }}</span></div>
              <div class="kv"><span class="k">Total</span><span class="v">R$ {{ p.totals?.grand_total | number:'1.2-2' }}</span></div>
            </div>
            <div class="card itens compact">
              <div class="card-head">
                <button class="btn ghost icon-left" (click)="$event.stopPropagation(); openItemsModal(p)" aria-label="Ver itens do pedido">
                  üõçÔ∏è <span>Itens</span>
                </button>
              </div>
            </div>
          </div>
        </section>
      </article>
    </section>

    <ng-template #stateBlock>
      <div class="loading" *ngIf="carregando">Carregando...</div>
      <div class="vazio" *ngIf="!carregando && !pedidos.length">Nenhum pedido encontrado.</div>
      <div class="erro" *ngIf="!carregando && erro">{{ erro }}</div>
    </ng-template>

    <div class="paginacao" *ngIf="totalPages > 1">
      <button class="btn btn-sec" (click)="prevPage()" [disabled]="page<=1">Anterior</button>
      <span class="muted">P√°gina {{ page }} / {{ totalPages }}</span>
      <button class="btn" (click)="nextPage()" [disabled]="page>=totalPages">Pr√≥xima</button>
    </div>
  </main>
</div>

<!-- Named outlet para abrir o modal de status -->
<router-outlet name="modal"></router-outlet>

<!-- Modal de Itens do Pedido -->
<div class="overlay" *ngIf="showItemsModal" (click)="closeItemsModal()" aria-hidden="true"></div>
<div class="itens-modal" *ngIf="showItemsModal" role="dialog" aria-label="Itens do pedido" (click)="$event.stopPropagation()">
  <header>
    <h3>Pedido #{{ modalPedido?.id }}</h3>
    <button class="close" (click)="closeItemsModal()" aria-label="Fechar">√ó</button>
  </header>
  <div class="body">
    <ng-container *ngIf="(modalItems?.length || 0) > 0; else vazioModal">
      <ul class="lista-itens">
        <li *ngFor="let it of modalItems">
          <div class="nome">{{ it.nome }}</div>
          <div class="meta">Qtd: {{ it.quantidade }} ‚Ä¢ R$ {{ it.unit | number:'1.2-2' }}</div>
          <div class="pos">Subtotal: R$ {{ it.subtotal | number:'1.2-2' }}</div>
        </li>
      </ul>
    </ng-container>
    <ng-template #vazioModal>
      <div class="vazio">Nenhum item encontrado para este pedido.</div>
    </ng-template>
  </div>
</div>
