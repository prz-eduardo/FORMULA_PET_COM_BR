<div class="loja-wrap loja-container">
  <app-navmenu></app-navmenu>
  <!-- Hero/Banner -->
  <section class="hero">
  <!-- <img class="hero-img" src="https://images.unsplash.com/photo-1583511655857-d19b40a7a54e?q=80&w=1600&auto=format&fit=crop" alt="Pets felizes" loading="lazy" decoding="async" /> -->
    <img src="imagens/banner.jpg"  alt="Pets felizes" loading="lazy" decoding="async">
    <div class="hero-overlay">
      <h1 class="titulo">Formula Pet</h1>
      <p class="subtitle">Do focinho ao rabinho a dose certa de carinho!üíì</p>
    </div>
  </section>

  <div class="filtros card" [class.search-active]="filtro && filtro.trim().length > 0">
      <button class="btn light icon filter" (click)="openFilters()" aria-haspopup="dialog" aria-label="Filtros" title="Filtros">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" stroke="#111827" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
        </svg>
      </button>
      <!-- Favoritos (esquerda) -->
      <button class="btn light icon icon-only fav-toggle" *ngIf="me" [class.active]="onlyFavorites" (click)="toggleFavoritesOnly()" [attr.aria-pressed]="onlyFavorites" aria-label="Mostrar apenas favoritos" title="Favoritos">
        ‚ù§
      </button>
      <div class="active-badges" *ngIf="activeFiltersDetailed.length" (click)="onBadgesContainerClick($event)">
        <ng-container *ngFor="let f of activeFiltersDetailed; trackBy: trackFilter">
          <button type="button" class="mini-badge closable" [attr.data-key]="f.key" [attr.aria-label]="'Remover ' + f.label" [title]="'Remover ' + f.label">
            {{ f.label }}
            <span class="x" aria-hidden="true">√ó</span>
          </button>
        </ng-container>
      </div>
      <!-- Espa√ßador para separar lados -->
      <div class="spacer" aria-hidden="true"></div>
    <div class="cta">
      <div class="perfil">
        <button #profileBtn class="btn light" (click)="toggleLogin($event)" aria-haspopup="dialog" [attr.aria-expanded]="showLogin">
            {{ me ? 'üë§ ' + (me?.nome?.split(' ')[0] || 'Cliente') : 'Login' }}
        </button>
      </div>
        <button #cartBtn type="button" (click)="onCartClick($event)" class="btn cart-link with-badge" title="Ir para o carrinho" aria-label="Carrinho">
          <img src="/icones/carrinho.png" class="carrinho-header" width="30" height="30" alt="Carrinho">

        <span class="cart-badge" *ngIf="cartCount > 0" aria-label="Itens no carrinho">{{ cartCount }}</span>
      </button>
    </div>
  </div>

  <div class="cats" *ngIf="categorias.length">
    <button class="chip" [class.active]="!categoria" (click)="onCategoryChange('')">Todas</button>
    <button class="chip promo" [class.active]="promoOnly" (click)="selectPromotions()">Promo√ß√µes</button>
    <button class="chip" *ngFor="let c of categorias; trackBy: trackCategory" [class.active]="categoria===c.nome" (click)="onCategoryChange(c.nome)">{{ c.nome }} <span class="count">({{ c.produtos }})</span></button>
  </div>

  <div class="meta" aria-live="polite">{{ onlyFavorites ? filtered.length : total }} itens</div>

  <!-- Se√ß√£o Destaques (PC only; at√© 5 por p√°gina) -->
  <section class="destaques desktop-only" *ngIf="featuredTopList.length > 0">
    <h2 class="sec-title">Destaques</h2>
    <!-- faixa horizontal com alguns cards em destaque -->
    <div class="destaque-row">
  <a class="d-card" *ngFor="let p of featuredRowList; trackBy: trackProduct" [routerLink]="'/produto/' + p.id" [queryParams]="{ src: 'loja' }" [title]="p.name">
  <img class="d-img" [src]="p.image || p.imageUrl" loading="lazy" decoding="async" [alt]="p.name" title="{{ p.name }}" />
        <div class="d-overlay">
          <div class="d-topline">
            <span class="d-badge" *ngIf="(p.discount || 0) > 0">-{{ (p.discount || 0) | number:'1.0-0' }}%</span>
            <span class="d-type" *ngIf="p.tipo === 'manipulado'">Manipulado</span>
          </div>
          <h3 class="d-title">{{ p.name }}</h3>
          <div class="d-price">
            <span class="new">{{ price(p) | currency:'BRL':'symbol-narrow':'1.2-2':'pt-BR' }}</span>
            <span class="old" *ngIf="p.promoPrice != null || (p.discount || 0) > 0">{{ p.price | currency:'BRL':'symbol-narrow':'1.2-2':'pt-BR' }}</span>
          </div>
          <button type="button" class="fav" (click)="onToggleFavFromCard(p, $event)" [attr.aria-pressed]="isFav(p)">
            <span class="heart">{{ isFav(p) ? '‚ù§Ô∏è' : 'ü§ç' }}</span>
            <span class="count" *ngIf="p.favoritesCount != null">{{ p.favoritesCount }}</span>
          </button>
          <button type="button" class="btn add" (click)="onAddToCartFromCard(p, $event)" [attr.aria-label]="'Adicionar ' + p.name + ' ao carrinho'" title="Adicionar ao carrinho"><img src="/icones/carrinho.png" class="icones-carrinho" width="30" height="30" alt="Carrinho"></button>
        </div>
      </a>
    </div>
  </section>

  <section class="catalogo">
    <h2 class="sec-title">{{ onlyFavorites ? 'Favoritos' : 'Produtos' }}</h2>
  <!-- Lista intercalada com banner por pagina√ß√£o (mobile e desktop) -->
  <div class="grid" [class.loading]="loading">
  <ng-container *ngIf="!loading && onlyFavorites && filtered.length === 0">
        <div class="empty-state">
          <div class="icon">‚ù§</div>
          <h3>Voc√™ ainda n√£o favoritou nenhum produto</h3>
          <p>Comece a favoritar para que eles apare√ßam aqui.</p>
          <div class="tips">Dica: toque no cora√ß√£o nos cards de produto para adicionar aos favoritos.</div>
        </div>
      </ng-container>
      <div class="grid-loader" *ngIf="loading">
        <div class="skeleton-card" *ngFor="let i of [1,2,3,4,5,6,7,8]"></div>
      </div>
      <!-- Mobile: destaque do primeiro produto -->
      <ng-container *ngIf="interleavedList.length > 0 && interleavedList[0].type === 'product'">
        <a class="d-card banner mobile-feature" [routerLink]="'/produto/' + interleavedList[0].product.id" [queryParams]="{ src: 'loja' }" [title]="interleavedList[0].product.name">
          <img class="d-img" [src]="interleavedList[0].product.image || interleavedList[0].product.imageUrl" loading="lazy" decoding="async" [alt]="interleavedList[0].product.name" title="{{ interleavedList[0].product.name }}" />
          <div class="d-overlay">
            <div class="d-topline">
              <span class="d-badge" *ngIf="(interleavedList[0].product.discount || 0) > 0">-{{ (interleavedList[0].product.discount || 0) | number:'1.0-0' }}%</span>
              <span class="d-type" *ngIf="interleavedList[0].product.tipo === 'manipulado'">Manipulado</span>
            </div>
            <h3 class="d-title">{{ interleavedList[0].product.name }}</h3>
            <div class="d-price">
              <span class="new">{{ price(interleavedList[0].product) | currency:'BRL':'symbol-narrow':'1.2-2':'pt-BR' }}</span>
              <span class="old" *ngIf="interleavedList[0].product.promoPrice != null || (interleavedList[0].product.discount || 0) > 0">{{ interleavedList[0].product.price | currency:'BRL':'symbol-narrow':'1.2-2':'pt-BR' }}</span>
            </div>
          </div>
        </a>
      </ng-container>
      <ng-container *ngFor="let it of interleavedList; let i = index; trackBy: trackInterleaved">
        <ng-container *ngIf="!(i === 0 && it.type === 'product')" [ngSwitch]="it.type">
          <a *ngSwitchCase="'banner'" class="d-card banner" [routerLink]="'/produto/' + it.product.id" [queryParams]="{ src: 'loja' }" [title]="it.product.name">
            <img class="d-img" [src]="it.product.image || it.product.imageUrl" loading="lazy" decoding="async" [alt]="it.product.name" title="{{ it.product.name }}" />
            <div class="d-overlay">
              <div class="d-topline">
                <span class="d-badge" *ngIf="(it.product.discount || 0) > 0">-{{ (it.product.discount || 0) | number:'1.0-0' }}%</span>
                <span class="d-type" *ngIf="it.product.tipo === 'manipulado'">Manipulado</span>
              </div>
              <h3 class="d-title">{{ it.product.name }}</h3>
              <div class="d-price">
                <span class="new">{{ price(it.product) | currency:'BRL':'symbol-narrow':'1.2-2':'pt-BR' }}</span>
                <span class="old" *ngIf="it.product.promoPrice != null || (it.product.discount || 0) > 0">{{ it.product.price | currency:'BRL':'symbol-narrow':'1.2-2':'pt-BR' }}</span>
              </div>
              <div class="d-actions">
                <button type="button" class="btn fav" [class.active]="isFav(it.product)" (click)="onToggleFavFromCard(it.product, $event)" aria-label="Favoritar">‚ù§</button>
                <button type="button" class="btn add" (click)="onAddToCartFromCard(it.product, $event)" [attr.aria-label]="'Adicionar ' + it.product.name + ' ao carrinho'" title="Adicionar ao carrinho"><img src="/icones/carrinho.png" class="icones-carrinho" width="30" height="30" alt="Carrinho"></button>
              </div>
            </div>
          </a>
          <app-product-card-v2 *ngSwitchCase="'product'"
            [product]="it.product"
            [supportsFavorites]="(storeMeta?.supports?.favorites ?? true) && !!me"
            [supportsRatings]="storeMeta?.supports?.ratings ?? true"
            [favoriteActive]="isFav(it.product)"
            (toggleFav)="toggleFav(it.product)"
            (add)="onAddToCart(it.product, $event)"
          ></app-product-card-v2>
        </ng-container>
      </ng-container>
      <div #infiniteAnchor class="infinite-anchor" aria-hidden="true"></div>
    </div>
    <!-- Pagina√ß√£o cl√°ssica removida por conta do infinite scroll -->
  </section>

  <!-- Modal de Filtros -->
  <div class="overlay" *ngIf="showFilters" (click)="closeFilters()"></div>
  <div class="filters-modal" *ngIf="showFilters" role="dialog" aria-label="Filtros da loja" (click)="$event.stopPropagation()">
    <header>
      <h3>Filtros</h3>
      <button class="close-btn" (click)="closeFilters()" aria-label="Fechar filtros" title="Fechar">√ó</button>
    </header>
    <div class="body">
      <label class="field">Buscar
        <input class="input" type="text" [(ngModel)]="filtroDraft" placeholder="Nome do produto ou termos" />
      </label>
      <label class="field">Categoria
        <select class="input" [(ngModel)]="categoriaDraft">
          <option value="">Todas categorias</option>
          <option *ngFor="let c of categorias" [ngValue]="c.nome">{{ c.nome }} ({{ c.produtos }})</option>
        </select>
      </label>
      <label class="field">Ordenar por
        <select class="input" [(ngModel)]="sortDraft">
          <option [ngValue]="'relevance'">Mais relevantes</option>
          <option [ngValue]="'newest'">Mais recentes</option>
          <option [ngValue]="'price_asc'">Menor pre√ßo</option>
          <option [ngValue]="'price_desc'">Maior pre√ßo</option>
          <option [ngValue]="'rating'">Melhor avalia√ß√£o</option>
          <option [ngValue]="'popularity'">Mais populares</option>
        </select>
      </label>
      <div class="field two-cols">
        <label>Pre√ßo m√≠nimo
          <input class="input" type="number" min="0" [(ngModel)]="minPriceDraft" placeholder="0" />
        </label>
        <label>Pre√ßo m√°ximo
          <input class="input" type="number" min="0" [(ngModel)]="maxPriceDraft" placeholder="1000" />
        </label>
      </div>
      <div class="field two-cols">
        <label>Somente em promo√ß√£o
          <input type="checkbox" [(ngModel)]="promoOnlyDraft" />
        </label>
        <label>Apenas com estoque
          <input type="checkbox" [(ngModel)]="inStockOnlyDraft" />
        </label>
      </div>
      <label class="field">Avalia√ß√£o m√≠nima
        <select class="input" [(ngModel)]="minRatingDraft">
          <option [ngValue]="0">Qualquer</option>
          <option [ngValue]="3">3+ estrelas</option>
          <option [ngValue]="4">4+ estrelas</option>
          <option [ngValue]="4.5">4.5+ estrelas</option>
        </select>
      </label>
    </div>
    <footer>
      <button class="btn light" (click)="clearFilters()">Limpar</button>
      <button class="btn" (click)="applyFilters()">Aplicar</button>
    </footer>
  </div>

  <!-- CTA: n√£o encontrou? Fale com a gente -->
  <section class="cta-help card">
    <div class="cta-text">
      <h3>N√£o encontrou o que procurava?</h3>
      <p>Nos envie uma mensagem que ajudamos voc√™ a encontrar o produto ideal para o seu pet.</p>
      <a class="btn whatsapp" href="https://wa.me/554132051910?text=Ol√°!%20Estou%20na%20loja%20e%20n√£o%20encontrei%20o%20que%20procurava." target="_blank" rel="noopener">
        <span class="wa-icon" aria-hidden="true"></span>
        <span>Falar no WhatsApp</span>
      </a>
    </div>
    <div class="cta-media">
      <img src="imagens/gato-cachorro-rato.png" alt="Cachorro e gato juntos deitados" />
    </div>
  </section>

  <!-- Login Overlay & Popover (fixed, acima de tudo) -->
  <div class="login-overlay" *ngIf="showLogin" [class.closing]="closingLogin" (click)="closeLogin()"></div>
  <div class="login-popover" *ngIf="showLogin" [class.closing]="closingLogin" [ngStyle]="{ top: popoverTop + 'px', left: popoverLeft + 'px' }" (click)="$event.stopPropagation()" role="dialog" aria-label="Login do cliente">
    <div class="popover-header">
      <div *ngIf="!me">Entrar</div>
      <div *ngIf="me">Ol√°, {{ me?.nome?.split(' ')[0] || 'cliente' }} üëã</div>
    </div>
    <div class="popover-body" *ngIf="!me && !showEmailLogin">
      <button class="btn google" (click)="doLoginGoogle()"><img src="imagens/google.png" alt="Google" class="g-img">Entrar com Google</button>
      <button class="btn light full" (click)="toggleEmailLogin()">Entrar com e‚Äëmail e senha</button>
      <a class="btn create-account full" [routerLink]="['/area-cliente']" [queryParams]="{ cadastro: '1' }">Criar conta</a>
    </div>
    <div class="popover-body" *ngIf="!me && showEmailLogin">
      <input class="input" type="email" [(ngModel)]="email" placeholder="E-mail" aria-label="E-mail" />
      <input class="input" type="password" [(ngModel)]="senha" placeholder="Senha" aria-label="Senha" />
      <button class="btn primary" (click)="doLogin()">Entrar</button>
      
      <button class="btn light" (click)="resetSenha()">Esqueci minha senha</button>
      <button class="btn light full" (click)="toggleEmailLogin()">Login com Google</button>
      <a class="btn create-account full" [routerLink]="['/area-cliente']" [queryParams]="{ cadastro: '1' }">Criar conta</a>
    </div>
    <div class="popover-body" *ngIf="me">
      <div class="welcome">Bem-vindo!</div>
      <div class="divider"></div>
      <button class="btn" (click)="logout()">Sair</button>
    </div>
  </div>

  
</div>
<app-footer></app-footer>
