<div class="loja-wrap">
  <app-navmenu></app-navmenu>
  <!-- Hero/Banner -->
  <section class="hero">
    <img class="hero-img" src="https://images.unsplash.com/photo-1583511655857-d19b40a7a54e?q=80&w=1600&auto=format&fit=crop" alt="Pets felizes" />
    <div class="hero-overlay">
      <h1 class="titulo">Loja</h1>
      <p class="subtitle">Medicamentos, suplementos e cuidados para o seu pet</p>
    </div>
  </section>

  <div class="filtros card">
    <input class="input" placeholder="Buscar produtos..." [ngModel]="filtro" (ngModelChange)="onQueryChange($event)" aria-label="Buscar produtos" />
    <select class="input" [ngModel]="categoria" (ngModelChange)="onCategoryChange($event)" aria-label="Filtrar por categoria">
      <option value="">Todas categorias</option>
      <option *ngFor="let c of categorias" [value]="c.nome">{{ c.nome }} ({{ c.produtos }})</option>
    </select>
    <select class="input" [ngModel]="sort" (ngModelChange)="onSortChange($event)" aria-label="Ordenar">
      <option value="relevance">Mais relevantes</option>
      <option value="newest">Mais recentes</option>
      <option value="price_asc">Menor preço</option>
      <option value="price_desc">Maior preço</option>
      <option value="rating">Melhor avaliação</option>
      <option value="popularity">Mais populares</option>
    </select>
    <div class="cta">
      <button class="btn light fav-toggle" [class.active]="onlyFavorites" (click)="toggleFavoritesOnly()" [attr.aria-pressed]="onlyFavorites" title="Mostrar apenas favoritos">
        ❤️ Favoritos
      </button>
      <div class="perfil">
        <button #profileBtn class="btn light" (click)="toggleLogin($event)" aria-haspopup="dialog" [attr.aria-expanded]="showLogin">
          {{ me ? '👤 ' + (me?.nome || 'Cliente') : '👤 Entrar' }}
        </button>
      </div>
      <button #cartBtn type="button" (click)="onCartClick($event)" class="btn cart-link with-badge" title="Ir para o carrinho">
        🛒 Carrinho
        <span class="cart-badge" *ngIf="cartCount > 0" aria-label="Itens no carrinho">{{ cartCount }}</span>
      </button>
    </div>
  </div>

  <div class="cats" *ngIf="categorias.length">
    <button class="chip" [class.active]="!categoria" (click)="onCategoryChange('')">Todas</button>
    <button class="chip" *ngFor="let c of categorias" [class.active]="categoria===c.nome" (click)="onCategoryChange(c.nome)">{{ c.nome }} <span class="count">({{ c.produtos }})</span></button>
  </div>

  <div class="meta" aria-live="polite">{{ onlyFavorites ? filtered.length : total }} itens</div>

  <section class="catalogo">
    <h2 class="sec-title">Produtos</h2>
    <div class="grid" [class.loading]="loading">
      <div class="grid-loader" *ngIf="loading">
        <div class="skeleton-card" *ngFor="let i of [1,2,3,4,5,6,7,8]"></div>
      </div>
      <app-product-card-v2 *ngFor="let p of paginated"
        [product]="p"
        [supportsFavorites]="storeMeta?.supports?.favorites ?? true"
        [supportsRatings]="storeMeta?.supports?.ratings ?? true"
        [favoriteActive]="isFav(p)"
        (toggleFav)="toggleFav(p)"
        (add)="onAddToCart(p, $event)"
      ></app-product-card-v2>
    </div>
    <div class="paginacao" *ngIf="filtered.length > pageSize">
      <div class="left">
        <label>Itens por página
          <select [ngModel]="pageSize" (ngModelChange)="onChangePageSize($event)">
            <option [ngValue]="20">20</option>
            <option [ngValue]="40">40</option>
            <option [ngValue]="60">60</option>
          </select>
        </label>
  <span class="range">{{ pageStart() }}–{{ pageEnd() }} de {{ filtered.length }}</span>
      </div>
      <div class="right">
        <button class="btn light" (click)="prevPage()" [disabled]="!canPrev()">Anterior</button>
        <span>Página {{ page }} de {{ totalPages() }}</span>
        <button class="btn light" (click)="nextPage()" [disabled]="!canNext()">Próxima</button>
      </div>
    </div>
  </section>

  <!-- CTA: não encontrou? Fale com a gente -->
  <section class="cta-help card">
    <div class="cta-text">
      <h3>Não encontrou o que procurava?</h3>
      <p>Nos envie uma mensagem que ajudamos você a encontrar o produto ideal para o seu pet.</p>
      <a class="btn whatsapp" href="https://wa.me/554132051910?text=Olá!%20Estou%20na%20loja%20e%20não%20encontrei%20o%20que%20procurava." target="_blank" rel="noopener">Falar no WhatsApp</a>
    </div>
    <div class="cta-media">
      <img src="imagens/gato-cachorro-rato.png" alt="Cachorro e gato juntos" />
    </div>
  </section>

  <!-- Login Overlay & Popover (fixed, acima de tudo) -->
  <div class="login-overlay" *ngIf="showLogin" (click)="closeLogin()"></div>
  <div class="login-popover" *ngIf="showLogin" [ngStyle]="{ top: popoverTop + 'px', left: popoverLeft + 'px' }" (click)="$event.stopPropagation()" role="dialog" aria-label="Login do cliente">
    <div class="popover-header">
      <div *ngIf="!me">Entrar</div>
      <div *ngIf="me">Olá, {{ me?.nome?.split(' ')[0] || 'cliente' }} 👋</div>
    </div>
    <div class="popover-body" *ngIf="!me && !showEmailLogin">
      
      <button class="btn google" (click)="doLoginGoogle()"><img src="imagens/google.png" alt="Google" class="g-img">Entrar com Google</button>
      <button class="btn light full" (click)="toggleEmailLogin()">Entrar com e‑mail e senha</button>
      <a class="link" [routerLink]="['/area-cliente']" [queryParams]="{ cadastro: '1' }">Criar conta</a>
    </div>
    <div class="popover-body" *ngIf="!me && showEmailLogin">
      <input class="input" type="email" [(ngModel)]="email" placeholder="E-mail" aria-label="E-mail" />
      <input class="input" type="password" [(ngModel)]="senha" placeholder="Senha" aria-label="Senha" />
      <button class="btn primary" (click)="doLogin()">Entrar</button>
      
      <button class="btn light" (click)="resetSenha()">Esqueci minha senha</button>
      <button class="btn light full" (click)="toggleEmailLogin()">Login com Google</button>
      <a class="link" [routerLink]="['/area-cliente']" [queryParams]="{ cadastro: '1' }">Criar conta</a>
    </div>
    <div class="popover-body" *ngIf="me">
      <div class="welcome">Bem-vindo, {{ me?.nome?.split(' ')[0] }}!</div>
      <div class="divider"></div>
      <a class="btn light full" routerLink="/area-cliente">Ir para Área do Cliente</a>
      <button class="btn" (click)="logout()">Sair</button>
    </div>
  </div>

  <app-footer></app-footer>
</div>
