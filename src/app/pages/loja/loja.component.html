<div class="loja-wrap">
  <app-navmenu></app-navmenu>
  <!-- Hero/Banner -->
  <section class="hero">
    <img class="hero-img" src="https://images.unsplash.com/photo-1583511655857-d19b40a7a54e?q=80&w=1600&auto=format&fit=crop" alt="Pets felizes" />
    <div class="hero-overlay">
      <h1 class="titulo">Loja</h1>
      <p class="subtitle">Medicamentos, suplementos e cuidados para o seu pet</p>
    </div>
  </section>

  <div class="filtros card">
      <button class="btn light icon filter" (click)="openFilters()" aria-haspopup="dialog" aria-label="Filtros" title="Filtros">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" stroke="#111827" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
        </svg>
      </button>
    <div class="cta">
      <!-- Favoritos s√≥ aparece logado -->
      <button class="btn light fav-toggle" *ngIf="me" [class.active]="onlyFavorites" (click)="toggleFavoritesOnly()" [attr.aria-pressed]="onlyFavorites" title="Mostrar apenas favoritos">
        ‚ù§Ô∏è Favoritos
      </button>
      <div class="perfil">
        <button #profileBtn class="btn light" (click)="toggleLogin($event)" aria-haspopup="dialog" [attr.aria-expanded]="showLogin">
            {{ me ? 'üë§ ' + (me?.nome?.split(' ')[0] || 'Cliente') : 'üë§ Entrar' }}
        </button>
      </div>
        <button #cartBtn type="button" (click)="onCartClick($event)" class="btn cart-link with-badge" title="Ir para o carrinho" aria-label="Carrinho">
          üõí
        <span class="cart-badge" *ngIf="cartCount > 0" aria-label="Itens no carrinho">{{ cartCount }}</span>
      </button>
    </div>
  </div>

  <div class="cats" *ngIf="categorias.length">
    <button class="chip" [class.active]="!categoria" (click)="onCategoryChange('')">Todas</button>
    <button class="chip" *ngFor="let c of categorias" [class.active]="categoria===c.nome" (click)="onCategoryChange(c.nome)">{{ c.nome }} <span class="count">({{ c.produtos }})</span></button>
  </div>

  <div class="meta" aria-live="polite">{{ onlyFavorites ? filtered.length : total }} itens</div>

  <section class="catalogo">
    <h2 class="sec-title">Produtos</h2>
    <div class="grid" [class.loading]="loading">
      <div class="empty-state" *ngIf="!loading && onlyFavorites && filtered.length === 0">
        <div class="icon">‚ù§</div>
        <h3>Voc√™ ainda n√£o favoritou nenhum produto</h3>
        <p>Comece a favoritar para que eles apare√ßam aqui.</p>
        <div class="tips">Dica: toque no cora√ß√£o nos cards de produto para adicionar aos favoritos.</div>
      </div>
      <div class="grid-loader" *ngIf="loading">
        <div class="skeleton-card" *ngFor="let i of [1,2,3,4,5,6,7,8]"></div>
      </div>
      <app-product-card-v2 *ngFor="let p of paginated"
        [product]="p"
        [supportsFavorites]="(storeMeta?.supports?.favorites ?? true) && !!me"
        [supportsRatings]="storeMeta?.supports?.ratings ?? true"
        [favoriteActive]="isFav(p)"
        (toggleFav)="toggleFav(p)"
        (add)="onAddToCart(p, $event)"
      ></app-product-card-v2>
    </div>
    <div class="paginacao" *ngIf="filtered.length > pageSize">
      <div class="left">
        <label>Itens por p√°gina
          <select [ngModel]="pageSize" (ngModelChange)="onChangePageSize($event)">
            <option [ngValue]="20">20</option>
            <option [ngValue]="40">40</option>
            <option [ngValue]="60">60</option>
          </select>
        </label>
  <span class="range">{{ pageStart() }}‚Äì{{ pageEnd() }} de {{ filtered.length }}</span>
      </div>
      <div class="right">
        <button class="btn light" (click)="prevPage()" [disabled]="!canPrev()">Anterior</button>
        <span>P√°gina {{ page }} de {{ totalPages() }}</span>
        <button class="btn light" (click)="nextPage()" [disabled]="!canNext()">Pr√≥xima</button>
      </div>
    </div>
  </section>

  <!-- Modal de Filtros -->
  <div class="overlay" *ngIf="showFilters" (click)="closeFilters()"></div>
  <div class="filters-modal" *ngIf="showFilters" role="dialog" aria-label="Filtros da loja" (click)="$event.stopPropagation()">
    <header>
      <h3>Filtros</h3>
    </header>
    <div class="body">
      <label class="field">Buscar
        <input class="input" type="text" [(ngModel)]="filtroDraft" placeholder="Nome do produto ou termos" />
      </label>
      <label class="field">Categoria
        <select class="input" [(ngModel)]="categoriaDraft">
          <option value="">Todas categorias</option>
          <option *ngFor="let c of categorias" [ngValue]="c.nome">{{ c.nome }} ({{ c.produtos }})</option>
        </select>
      </label>
      <label class="field">Ordenar por
        <select class="input" [(ngModel)]="sortDraft">
          <option [ngValue]="'relevance'">Mais relevantes</option>
          <option [ngValue]="'newest'">Mais recentes</option>
          <option [ngValue]="'price_asc'">Menor pre√ßo</option>
          <option [ngValue]="'price_desc'">Maior pre√ßo</option>
          <option [ngValue]="'rating'">Melhor avalia√ß√£o</option>
          <option [ngValue]="'popularity'">Mais populares</option>
        </select>
      </label>
      <div class="field two-cols">
        <label>Pre√ßo m√≠nimo
          <input class="input" type="number" min="0" [(ngModel)]="minPriceDraft" placeholder="0" />
        </label>
        <label>Pre√ßo m√°ximo
          <input class="input" type="number" min="0" [(ngModel)]="maxPriceDraft" placeholder="1000" />
        </label>
      </div>
      <div class="field two-cols">
        <label>Somente em promo√ß√£o
          <input type="checkbox" [(ngModel)]="promoOnlyDraft" />
        </label>
        <label>Apenas com estoque
          <input type="checkbox" [(ngModel)]="inStockOnlyDraft" />
        </label>
      </div>
      <label class="field">Avalia√ß√£o m√≠nima
        <select class="input" [(ngModel)]="minRatingDraft">
          <option [ngValue]="0">Qualquer</option>
          <option [ngValue]="3">3+ estrelas</option>
          <option [ngValue]="4">4+ estrelas</option>
          <option [ngValue]="4.5">4.5+ estrelas</option>
        </select>
      </label>
    </div>
    <footer>
      <button class="btn light" (click)="clearFilters()">Limpar</button>
      <button class="btn" (click)="applyFilters()">Aplicar</button>
    </footer>
  </div>

  <!-- CTA: n√£o encontrou? Fale com a gente -->
  <section class="cta-help card">
    <div class="cta-text">
      <h3>N√£o encontrou o que procurava?</h3>
      <p>Nos envie uma mensagem que ajudamos voc√™ a encontrar o produto ideal para o seu pet.</p>
      <a class="btn whatsapp" href="https://wa.me/554132051910?text=Ol√°!%20Estou%20na%20loja%20e%20n√£o%20encontrei%20o%20que%20procurava." target="_blank" rel="noopener">
        <span class="wa-icon" aria-hidden="true"></span>
        Falar no WhatsApp
      </a>
    </div>
    <div class="cta-media">
      <img src="imagens/gato-cachorro-rato.png" alt="Cachorro e gato juntos" />
    </div>
  </section>

  <!-- Login Overlay & Popover (fixed, acima de tudo) -->
  <div class="login-overlay" *ngIf="showLogin" [class.closing]="closingLogin" (click)="closeLogin()"></div>
  <div class="login-popover" *ngIf="showLogin" [class.closing]="closingLogin" [ngStyle]="{ top: popoverTop + 'px', left: popoverLeft + 'px' }" (click)="$event.stopPropagation()" role="dialog" aria-label="Login do cliente">
    <div class="popover-header">
      <div *ngIf="!me">Entrar</div>
      <div *ngIf="me">Ol√°, {{ me?.nome?.split(' ')[0] || 'cliente' }} üëã</div>
    </div>
    <div class="popover-body" *ngIf="!me && !showEmailLogin">
      <button class="btn google" (click)="doLoginGoogle()"><img src="imagens/google.png" alt="Google" class="g-img">Entrar com Google</button>
      <button class="btn light full" (click)="toggleEmailLogin()">Entrar com e‚Äëmail e senha</button>
      <a class="btn create-account full" [routerLink]="['/area-cliente']" [queryParams]="{ cadastro: '1' }">Criar conta</a>
    </div>
    <div class="popover-body" *ngIf="!me && showEmailLogin">
      <input class="input" type="email" [(ngModel)]="email" placeholder="E-mail" aria-label="E-mail" />
      <input class="input" type="password" [(ngModel)]="senha" placeholder="Senha" aria-label="Senha" />
      <button class="btn primary" (click)="doLogin()">Entrar</button>
      
      <button class="btn light" (click)="resetSenha()">Esqueci minha senha</button>
      <button class="btn light full" (click)="toggleEmailLogin()">Login com Google</button>
      <a class="btn create-account full" [routerLink]="['/area-cliente']" [queryParams]="{ cadastro: '1' }">Criar conta</a>
    </div>
    <div class="popover-body" *ngIf="me">
      <div class="welcome">Bem-vindo, {{ me?.nome?.split(' ')[0] }}!</div>
      <div class="divider"></div>
      <a class="btn light full" routerLink="/area-cliente">Ir para √Årea do Cliente</a>
      <button class="btn" (click)="logout()">Sair</button>
    </div>
  </div>

  <app-footer></app-footer>
</div>
