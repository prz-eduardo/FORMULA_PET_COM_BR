<div class="loja-wrap">
  <app-navmenu></app-navmenu>
  <!-- Hero/Banner -->
  <section class="hero">
    <img class="hero-img" src="https://images.unsplash.com/photo-1583511655857-d19b40a7a54e?q=80&w=1600&auto=format&fit=crop" alt="Pets felizes" />
    <div class="hero-overlay">
      <h1 class="titulo">Loja</h1>
      <p class="subtitle">Medicamentos, suplementos e cuidados para o seu pet</p>
    </div>
  </section>

  <div class="filtros card">
    <input class="input" placeholder="Buscar produtos..." [(ngModel)]="filtro" aria-label="Buscar produtos" />
    <select class="input" [(ngModel)]="categoria" aria-label="Filtrar por categoria">
      <option value="">Todas categorias</option>
      <option *ngFor="let c of categorias" [value]="c">{{ c }}</option>
    </select>
    <select class="input" [(ngModel)]="sort" aria-label="Ordenar">
      <option value="relevance">Mais relevantes</option>
      <option value="price-asc">Menor preço</option>
      <option value="price-desc">Maior preço</option>
      <option value="name">Nome (A-Z)</option>
    </select>
    <div class="cta">
      <button class="btn light fav-toggle" [class.active]="onlyFavorites" (click)="toggleFavoritesOnly()" [attr.aria-pressed]="onlyFavorites" title="Mostrar apenas favoritos">
        ❤️ Favoritos
      </button>
      <div class="perfil">
        <button #profileBtn class="btn light" (click)="toggleLogin($event)" aria-haspopup="dialog" [attr.aria-expanded]="showLogin">
          {{ me ? '👤 ' + (me?.nome || 'Cliente') : '👤 Entrar' }}
        </button>
      </div>
      <a #cartBtn routerLink="/carrinho" (click)="onCartClick($event)" class="btn cart-link with-badge" title="Ir para o carrinho">
        🛒 Carrinho
        <span class="cart-badge" *ngIf="cartCount > 0" aria-label="Itens no carrinho">{{ cartCount }}</span>
      </a>
    </div>
  </div>

  <div class="cats" *ngIf="categorias.length">
    <button class="chip" [class.active]="!categoria" (click)="categoria=''">Todas</button>
    <button class="chip" *ngFor="let c of categorias" [class.active]="categoria===c" (click)="categoria=c">{{ c }}</button>
  </div>

  <div class="meta" aria-live="polite">{{ filtered.length }} itens</div>

  <section class="catalogo">
    <h2 class="sec-title">Produtos</h2>
    <div class="grid">
      <div class="card produto" *ngFor="let p of paginated">
        <div class="img-box">
          <img [src]="p.image" width="320" height="200" alt="" role="presentation" />
          <div class="badge" *ngIf="p.discount">{{ p.discount }}% OFF</div>
          <button class="fav" (click)="toggleFav(p)" [attr.aria-pressed]="isFav(p)">
            {{ isFav(p) ? '❤️' : '🤍' }}
          </button>
          <button class="add-fab" (click)="onAddToCart(p, $event)" title="Adicionar ao carrinho">🛒</button>
        </div>
        <div class="info">
          <div class="top">
            <h3 class="nome">{{ p.name }}</h3>
            <div class="categoria">{{ p.category }}</div>
            <p class="desc">{{ p.description }}</p>
          </div>
          <div class="bottom">
            <div class="preco">
              <span class="atual">{{ price(p) | currency:'BRL' }}</span>
              <span *ngIf="p.discount" class="old">{{ p.price | currency:'BRL' }}</span>
            </div>
            <div class="acoes"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="paginacao" *ngIf="filtered.length > pageSize">
      <div class="left">
        <label>Itens por página
          <select [ngModel]="pageSize" (ngModelChange)="onChangePageSize($event)">
            <option [ngValue]="20">20</option>
            <option [ngValue]="40">40</option>
            <option [ngValue]="60">60</option>
          </select>
        </label>
  <span class="range">{{ pageStart() }}–{{ pageEnd() }} de {{ filtered.length }}</span>
      </div>
      <div class="right">
        <button class="btn light" (click)="prevPage()" [disabled]="!canPrev()">Anterior</button>
        <span>Página {{ page }} de {{ totalPages() }}</span>
        <button class="btn light" (click)="nextPage()" [disabled]="!canNext()">Próxima</button>
      </div>
    </div>
  </section>

  <!-- Login Overlay & Popover (fixed, acima de tudo) -->
  <div class="login-overlay" *ngIf="showLogin" (click)="closeLogin()"></div>
  <div class="login-popover" *ngIf="showLogin" [ngStyle]="{ top: popoverTop + 'px', left: popoverLeft + 'px' }" (click)="$event.stopPropagation()" role="dialog" aria-label="Login do cliente">
    <div class="popover-header">
      <div *ngIf="!me">Entrar</div>
      <div *ngIf="me">Olá, {{ me?.nome?.split(' ')[0] || 'cliente' }} 👋</div>
    </div>
    <div class="popover-body" *ngIf="!me && !showEmailLogin">
      
      <button class="btn google" (click)="doLoginGoogle()"><img src="imagens/google.png" alt="Google" class="g-img">Entrar com Google</button>
      <button class="btn light full" (click)="toggleEmailLogin()">Entrar com e‑mail e senha</button>
      <a class="link" [routerLink]="['/area-cliente']" [queryParams]="{ cadastro: '1' }">Criar conta</a>
    </div>
    <div class="popover-body" *ngIf="!me && showEmailLogin">
      <input class="input" type="email" [(ngModel)]="email" placeholder="E-mail" aria-label="E-mail" />
      <input class="input" type="password" [(ngModel)]="senha" placeholder="Senha" aria-label="Senha" />
      <button class="btn primary" (click)="doLogin()">Entrar</button>
      
      <button class="btn light" (click)="resetSenha()">Esqueci minha senha</button>
      <button class="btn light full" (click)="toggleEmailLogin()">Login com Google</button>
      <a class="link" [routerLink]="['/area-cliente']" [queryParams]="{ cadastro: '1' }">Criar conta</a>
    </div>
    <div class="popover-body" *ngIf="me">
      <div class="welcome">Bem-vindo, {{ me?.nome?.split(' ')[0] }}!</div>
      <div class="divider"></div>
      <a class="btn light full" routerLink="/area-cliente">Ir para Área do Cliente</a>
      <button class="btn" (click)="logout()">Sair</button>
    </div>
  </div>

  <app-footer></app-footer>
</div>
